= Invalid execution results =
| ----------------------------------- |
| Thread 1  |        Thread 2         |
| ----------------------------------- |
| bar(): -1 | foo(): SUSPENDED + void |
| ----------------------------------- |

The following interleaving leads to the error:
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                               Thread 1                                                |                                                Thread 2                                                |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| bar(): -1                                                                                             |                                                                                                        |
|   barStarted.WRITE(true) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:38)            |                                                                                                        |
|   lock(null): Unit@1 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:77)                |                                                                                                        |
|     tryLock(null): true at MutexImpl.lock(Mutex.kt:184)                                               |                                                                                                        |
|     switch                                                                                            |                                                                                                        |
|                                                                                                       | foo(): SUSPENDED + void                                                                                |
|                                                                                                       |   barStarted.READ: true at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29)              |
|                                                                                                       |   canEnterForbiddenBlock.WRITE(true) at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29) |
|                                                                                                       |   lock(null): CoroutineSingletons@1 at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:67)  |
|                                                                                                       |     tryLock(null): false at MutexImpl.lock(Mutex.kt:184)                                               |
|                                                                                                       |     lockSuspend(null): CoroutineSingletons@1 at MutexImpl.lock(Mutex.kt:186)                           |
|                                                                                                       |       _state.READ: Empty@1 at MutexImpl.lockSuspend(Mutex.kt:434)                                      |
|                                                                                                       |       _state.compareAndSet(Empty@1,LockedQueue@1): true at MutexImpl.lockSuspend(Mutex.kt:195)         |
|                                                                                                       |       _state.READ: LockedQueue@1 at MutexImpl.lockSuspend(Mutex.kt:434)                                |
|                                                                                                       |       addLast(LockCont@1) at MutexImpl.lockSuspend(Mutex.kt:210)                                       |
|                                                                                                       |       _state.READ: LockedQueue@1 at MutexImpl.lockSuspend(Mutex.kt:219)                                |
|                                                                                                       |   switch (reason: coroutine is suspended)                                                              |
|                                                                                                       |   result: SUSPENDED + void                                                                             |
|     INSTANCE.READ: Unit@1 at MutexImpl.lock(Mutex.kt:184)                                             |                                                                                                        |
|   counter.READ: 0 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                   |                                                                                                        |
|   counter.WRITE(1) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                  |                                                                                                        |
|   unlock(null) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:81)                      |                                                                                                        |
|   canEnterForbiddenBlock.READ: true at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:42) |                                                                                                        |
|   result: -1                                                                                          |                                                                                                        |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

Detailed trace:
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                                                Thread 1                                                                |                                                            Thread 2                                                            |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| bar(): -1                                                                                                                              |                                                                                                                                |
|   barStarted.WRITE(true) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:38)                                             |                                                                                                                                |
|   lock(null): Unit@1 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:77)                                                 |                                                                                                                                |
|     tryLock(null): true at MutexImpl.lock(Mutex.kt:184)                                                                                |                                                                                                                                |
|       _state.READ: Empty@2 at MutexImpl.tryLock(Mutex.kt:428)                                                                          |                                                                                                                                |
|       _state.compareAndSet(Empty@2,Empty@1): true at MutexImpl.tryLock(Mutex.kt:170)                                                   |                                                                                                                                |
|     switch                                                                                                                             |                                                                                                                                |
|                                                                                                                                        | foo(): SUSPENDED + void                                                                                                        |
|                                                                                                                                        |   barStarted.READ: true at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29)                                      |
|                                                                                                                                        |   canEnterForbiddenBlock.WRITE(true) at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29)                         |
|                                                                                                                                        |   lock(null): CoroutineSingletons@1 at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:67)                          |
|                                                                                                                                        |     tryLock(null): false at MutexImpl.lock(Mutex.kt:184)                                                                       |
|                                                                                                                                        |       _state.READ: Empty@1 at MutexImpl.tryLock(Mutex.kt:428)                                                                  |
|                                                                                                                                        |     lockSuspend(null): CoroutineSingletons@1 at MutexImpl.lock(Mutex.kt:186)                                                   |
|                                                                                                                                        |       _state.READ: Empty@1 at MutexImpl.lockSuspend(Mutex.kt:434)                                                              |
|                                                                                                                                        |       _state.compareAndSet(Empty@1,LockedQueue@1): true at MutexImpl.lockSuspend(Mutex.kt:195)                                 |
|                                                                                                                                        |       _state.READ: LockedQueue@1 at MutexImpl.lockSuspend(Mutex.kt:434)                                                        |
|                                                                                                                                        |       addLast(LockCont@1) at MutexImpl.lockSuspend(Mutex.kt:210)                                                               |
|                                                                                                                                        |         addNext(LockCont@1,LockedQueue@1): true at LockFreeLinkedListNode.addLast(LockFreeLinkedList.kt:144)                   |
|                                                                                                                                        |           _prev.lazySet(LockedQueue@1) at LockFreeLinkedListNode.addNext(LockFreeLinkedList.kt:215)                            |
|                                                                                                                                        |           _next.lazySet(LockedQueue@1) at LockFreeLinkedListNode.addNext(LockFreeLinkedList.kt:216)                            |
|                                                                                                                                        |           _next.compareAndSet(LockedQueue@1,LockCont@1): true at LockFreeLinkedListNode.addNext(LockFreeLinkedList.kt:217)     |
|                                                                                                                                        |           finishAdd(LockedQueue@1) at LockFreeLinkedListNode.addNext(LockFreeLinkedList.kt:219)                                |
|                                                                                                                                        |             _prev.compareAndSet(LockedQueue@1,LockCont@1): true at LockFreeLinkedListNode.finishAdd(LockFreeLinkedList.kt:548) |
|                                                                                                                                        |       _state.READ: LockedQueue@1 at MutexImpl.lockSuspend(Mutex.kt:219)                                                        |
|                                                                                                                                        |   switch (reason: coroutine is suspended)                                                                                      |
|                                                                                                                                        |   result: SUSPENDED + void                                                                                                     |
|     INSTANCE.READ: Unit@1 at MutexImpl.lock(Mutex.kt:184)                                                                              |                                                                                                                                |
|   counter.READ: 0 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                                                    |                                                                                                                                |
|   counter.WRITE(1) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                                                   |                                                                                                                                |
|   unlock(null) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:81)                                                       |                                                                                                                                |
|     _state.READ: LockedQueue@1 at MutexImpl.unlock(Mutex.kt:438)                                                                       |                                                                                                                                |
|     removeFirstOrNull(): LockCont@1 at MutexImpl.unlock(Mutex.kt:335)                                                                  |                                                                                                                                |
|       remove(): true at LockFreeLinkedListNode.removeFirstOrNull(LockFreeLinkedList.kt:288)                                            |                                                                                                                                |
|         removeOrNext(): null at LockFreeLinkedListNode.remove(LockFreeLinkedList.kt:245)                                               |                                                                                                                                |
|           removed(): Removed@1 at LockFreeLinkedListNode.removeOrNext(LockFreeLinkedList.kt:254)                                       |                                                                                                                                |
|             _removedRef.lazySet(Removed@1) at LockFreeLinkedListNode.removed(LockFreeLinkedList.kt:71)                                 |                                                                                                                                |
|           _next.compareAndSet(LockedQueue@1,Removed@1): true at LockFreeLinkedListNode.removeOrNext(LockFreeLinkedList.kt:255)         |                                                                                                                                |
|           correctPrev(null): LockedQueue@1 at LockFreeLinkedListNode.removeOrNext(LockFreeLinkedList.kt:257)                           |                                                                                                                                |
|             _next.compareAndSet(LockCont@1,LockedQueue@1): true at LockFreeLinkedListNode.correctPrev(LockFreeLinkedList.kt:601)       |                                                                                                                                |
|             _prev.compareAndSet(LockCont@1,LockedQueue@1): true at LockFreeLinkedListNode.correctPrev(LockFreeLinkedList.kt:583)       |                                                                                                                                |
|     tryResumeLockWaiter(): true at MutexImpl.unlock(Mutex.kt:340)                                                                      |                                                                                                                                |
|       take(): true at MutexImpl$LockCont.tryResumeLockWaiter(Mutex.kt:385)                                                             |                                                                                                                                |
|         isTaken.compareAndSet(0,1): true at MutexImpl$LockWaiter.take(Mutex.kt:373)                                                    |                                                                                                                                |
|       INSTANCE.READ: Unit@1 at MutexImpl$LockCont.tryResumeLockWaiter(Mutex.kt:386)                                                    |                                                                                                                                |
|       tryResume(Unit@1,null,@1): <RESUME_TOKEN> at MutexImpl$LockCont.tryResumeLockWaiter(Mutex.kt:386)                                |                                                                                                                                |
|         getJob(): JobImpl@1 at JobNode.dispose(JobSupport.kt:1358)                                                                     |                                                                                                                                |
|           job.READ: JobImpl@1 at JobNode.getJob(JobSupport.kt:1355)                                                                    |                                                                                                                                |
|         removeNode$kotlinx_coroutines_core(ChildContinuation@1) at JobNode.dispose(JobSupport.kt:1358)                                 |                                                                                                                                |
|           getState$kotlinx_coroutines_core(): ChildContinuation@1 at JobSupport.removeNode$kotlinx_coroutines_core(JobSupport.kt:1577) |                                                                                                                                |
|             _state.READ: ChildContinuation@1 at JobSupport.getState$kotlinx_coroutines_core(JobSupport.kt:1482)                        |                                                                                                                                |
|           _state.compareAndSet(ChildContinuation@1,Empty@1): true at JobSupport.removeNode$kotlinx_coroutines_core(JobSupport.kt:595)  |                                                                                                                                |
|     completeResumeLockWaiter() at MutexImpl.unlock(Mutex.kt:342)                                                                       |                                                                                                                                |
|       completeResume(<RESUME_TOKEN>) at MutexImpl$LockCont.completeResumeLockWaiter(Mutex.kt:392)                                      |                                                                                                                                |
|         size.READ: 2 at ArrayList.get(ArrayList.java:427)                                                                              |                                                                                                                                |
|         elementData(1): AtomicReferenceArray@1 at ArrayList.get(ArrayList.java:428)                                                    |                                                                                                                                |
|           elementData.READ: Object[]@1 at ArrayList.elementData(ArrayList.java:411)                                                    |                                                                                                                                |
|           Array[1].READ: AtomicReferenceArray@1 at ArrayList.elementData(ArrayList.java:411)                                           |                                                                                                                                |
|   canEnterForbiddenBlock.READ: true at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:42)                                  |                                                                                                                                |
|   result: -1                                                                                                                           |                                                                                                                                |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
