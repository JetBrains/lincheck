= Invalid execution results =
| ----------------------------------- |
| Thread 1  |        Thread 2         |
| ----------------------------------- |
| bar(): -1 | foo(): SUSPENDED + void |
| ----------------------------------- |

The following interleaving leads to the error:
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                               Thread 1                                                |                                                    Thread 2                                                    |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| bar(): -1                                                                                             |                                                                                                                |
|   barStarted.WRITE(true) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:38)            |                                                                                                                |
|   lock(null): Unit@1 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:72)                |                                                                                                                |
|     lock$suspendImpl(MutexImpl@1,null,<cont>): Unit@1 at MutexImpl.lock(Mutex.kt:0)                   |                                                                                                                |
|       tryLock(null): true at MutexImpl.lock$suspendImpl(Mutex.kt:166)                                 |                                                                                                                |
|         tryLockImpl(null): 0 at MutexImpl.tryLock(Mutex.kt:178)                                       |                                                                                                                |
|           tryAcquire(): true at MutexImpl.tryLockImpl(Mutex.kt:184)                                   |                                                                                                                |
|           owner$volatile.get(): <NO_OWNER> at MutexImpl.tryLockImpl(Mutex.kt:185)                     |                                                                                                                |
|           switch                                                                                      |                                                                                                                |
|                                                                                                       | foo(): SUSPENDED + void                                                                                        |
|                                                                                                       |   barStarted.READ: true at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29)                      |
|                                                                                                       |   canEnterForbiddenBlock.WRITE(true) at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29)         |
|                                                                                                       |   lock(null): CoroutineSingletons@1 at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:62)          |
|                                                                                                       |     lock$suspendImpl(MutexImpl@1,null,<cont>): CoroutineSingletons@1 at MutexImpl.lock(Mutex.kt:0)             |
|                                                                                                       |       tryLock(null): false at MutexImpl.lock$suspendImpl(Mutex.kt:166)                                         |
|                                                                                                       |       lockSuspend(null): CoroutineSingletons@1 at MutexImpl.lock$suspendImpl(Mutex.kt:167)                     |
|                                                                                                       |         acquire(<cont>) at MutexImpl.lockSuspend(Mutex.kt:172)                                                 |
|                                                                                                       |         getResult(): CoroutineSingletons@1 at MutexImpl.lockSuspend(Mutex.kt:316)                              |
|                                                                                                       |           trySuspend(): true at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:296)      |
|                                                                                                       |           getParentHandle(): null at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:306) |
|                                                                                                       |   switch (reason: coroutine is suspended)                                                                      |
|                                                                                                       |   result: SUSPENDED + void                                                                                     |
|           owner$volatile.set(null) at MutexImpl.tryLockImpl(Mutex.kt:186)                             |                                                                                                                |
|   counter.READ: 0 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                   |                                                                                                                |
|   counter.WRITE(1) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                  |                                                                                                                |
|   unlock(null) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:76)                      |                                                                                                                |
|   canEnterForbiddenBlock.READ: true at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:42) |                                                                                                                |
|   result: -1                                                                                          |                                                                                                                |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

Detailed trace:
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                                                                        Thread 1                                                                                        |                                                                                    Thread 2                                                                                    |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| bar(): -1                                                                                                                                                                              |                                                                                                                                                                                |
|   barStarted.WRITE(true) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:38)                                                                                             |                                                                                                                                                                                |
|   lock(null): Unit@1 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:72)                                                                                                 |                                                                                                                                                                                |
|     lock$suspendImpl(MutexImpl@1,null,<cont>): Unit@1 at MutexImpl.lock(Mutex.kt:0)                                                                                                    |                                                                                                                                                                                |
|       tryLock(null): true at MutexImpl.lock$suspendImpl(Mutex.kt:166)                                                                                                                  |                                                                                                                                                                                |
|         tryLockImpl(null): 0 at MutexImpl.tryLock(Mutex.kt:178)                                                                                                                        |                                                                                                                                                                                |
|           tryAcquire(): true at MutexImpl.tryLockImpl(Mutex.kt:184)                                                                                                                    |                                                                                                                                                                                |
|             _availablePermits$volatile.get(): 1 at SemaphoreImpl.tryAcquire(Semaphore.kt:154)                                                                                          |                                                                                                                                                                                |
|             _availablePermits$volatile.compareAndSet(1,0): true at SemaphoreImpl.tryAcquire(Semaphore.kt:166)                                                                          |                                                                                                                                                                                |
|           owner$volatile.get(): <NO_OWNER> at MutexImpl.tryLockImpl(Mutex.kt:185)                                                                                                      |                                                                                                                                                                                |
|           switch                                                                                                                                                                       |                                                                                                                                                                                |
|                                                                                                                                                                                        | foo(): SUSPENDED + void                                                                                                                                                        |
|                                                                                                                                                                                        |   barStarted.READ: true at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29)                                                                                      |
|                                                                                                                                                                                        |   canEnterForbiddenBlock.WRITE(true) at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29)                                                                         |
|                                                                                                                                                                                        |   lock(null): CoroutineSingletons@1 at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:62)                                                                          |
|                                                                                                                                                                                        |     lock$suspendImpl(MutexImpl@1,null,<cont>): CoroutineSingletons@1 at MutexImpl.lock(Mutex.kt:0)                                                                             |
|                                                                                                                                                                                        |       tryLock(null): false at MutexImpl.lock$suspendImpl(Mutex.kt:166)                                                                                                         |
|                                                                                                                                                                                        |         tryLockImpl(null): 1 at MutexImpl.tryLock(Mutex.kt:178)                                                                                                                |
|                                                                                                                                                                                        |           tryAcquire(): false at MutexImpl.tryLockImpl(Mutex.kt:184)                                                                                                           |
|                                                                                                                                                                                        |             _availablePermits$volatile.get(): 0 at SemaphoreImpl.tryAcquire(Semaphore.kt:154)                                                                                  |
|                                                                                                                                                                                        |       lockSuspend(null): CoroutineSingletons@1 at MutexImpl.lock$suspendImpl(Mutex.kt:167)                                                                                     |
|                                                                                                                                                                                        |         acquire(<cont>) at MutexImpl.lockSuspend(Mutex.kt:172)                                                                                                                 |
|                                                                                                                                                                                        |           decPermits(): 0 at SemaphoreImpl.acquire(Semaphore.kt:408)                                                                                                           |
|                                                                                                                                                                                        |             _availablePermits$volatile.getAndDecrement(): 0 at SemaphoreImpl.decPermits(Semaphore.kt:232)                                                                      |
|                                                                                                                                                                                        |           addAcquireToQueue(<cont>): true at SemaphoreImpl.acquire(Semaphore.kt:194)                                                                                           |
|                                                                                                                                                                                        |             tail$volatile.get(): SemaphoreSegment@1 at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:281)                                                                       |
|                                                                                                                                                                                        |             enqIdx$volatile.getAndIncrement(): 0 at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:282)                                                                          |
|                                                                                                                                                                                        |             findSegmentInternal(SemaphoreSegment@1,0,createNewSegment$1): SemaphoreSegment@1 at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:427)                              |
|                                                                                                                                                                                        |               isRemoved(): false at ConcurrentLinkedListKt.findSegmentInternal(ConcurrentLinkedList.kt:22)                                                                     |
|                                                                                                                                                                                        |                 cleanedAndPointers$volatile.get(): 131072 at Segment.isRemoved(ConcurrentLinkedList.kt:218)                                                                    |
|                                                                                                                                                                                        |             tail$volatile.get(): SemaphoreSegment@1 at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:428)                                                                       |
|                                                                                                                                                                                        |             compareAndSet(0,null,<cont>): true at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:437)                                                                            |
|                                                                                                                                                                                        |             invokeOnCancellation(SemaphoreSegment@1,0) at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:289)                                                                    |
|                                                                                                                                                                                        |               invokeOnCancellation(SemaphoreSegment@1,0) at MutexImpl$CancellableContinuationWithOwner.invokeOnCancellation(Mutex.kt:0)                                        |
|                                                                                                                                                                                        |                 _decisionAndIndex$volatile.get(): 536870911 at CancellableContinuationImpl.invokeOnCancellation(CancellableContinuationImpl.kt:383)                            |
|                                                                                                                                                                                        |                 _decisionAndIndex$volatile.compareAndSet(536870911,0): true at CancellableContinuationImpl.invokeOnCancellation(CancellableContinuationImpl.kt:388)            |
|                                                                                                                                                                                        |                 invokeOnCancellationImpl(SemaphoreSegment@1) at CancellableContinuationImpl.invokeOnCancellation(CancellableContinuationImpl.kt:390)                           |
|                                                                                                                                                                                        |                   _state$volatile.get(): Active@1 at CancellableContinuationImpl.invokeOnCancellationImpl(CancellableContinuationImpl.kt:398)                                  |
|                                                                                                                                                                                        |                   _state$volatile.compareAndSet(Active@1,SemaphoreSegment@1): true at CancellableContinuationImpl.invokeOnCancellationImpl(CancellableContinuationImpl.kt:403) |
|                                                                                                                                                                                        |         getResult(): CoroutineSingletons@1 at MutexImpl.lockSuspend(Mutex.kt:316)                                                                                              |
|                                                                                                                                                                                        |           trySuspend(): true at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:296)                                                                      |
|                                                                                                                                                                                        |             _decisionAndIndex$volatile.get(): 0 at CancellableContinuationImpl.trySuspend(CancellableContinuationImpl.kt:271)                                                  |
|                                                                                                                                                                                        |             _decisionAndIndex$volatile.compareAndSet(0,536870912): true at CancellableContinuationImpl.trySuspend(CancellableContinuationImpl.kt:274)                          |
|                                                                                                                                                                                        |           getParentHandle(): null at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:306)                                                                 |
|                                                                                                                                                                                        |             _parentHandle$volatile.get(): null at CancellableContinuationImpl.getParentHandle(CancellableContinuationImpl.kt:102)                                              |
|                                                                                                                                                                                        |   switch (reason: coroutine is suspended)                                                                                                                                      |
|                                                                                                                                                                                        |   result: SUSPENDED + void                                                                                                                                                     |
|           owner$volatile.set(null) at MutexImpl.tryLockImpl(Mutex.kt:186)                                                                                                              |                                                                                                                                                                                |
|   counter.READ: 0 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                                                                                                    |                                                                                                                                                                                |
|   counter.WRITE(1) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                                                                                                   |                                                                                                                                                                                |
|   unlock(null) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:76)                                                                                                       |                                                                                                                                                                                |
|     isLocked(): true at MutexImpl.unlock(Mutex.kt:208)                                                                                                                                 |                                                                                                                                                                                |
|       getAvailablePermits(): 0 at MutexImpl.isLocked(Mutex.kt:144)                                                                                                                     |                                                                                                                                                                                |
|         _availablePermits$volatile.get(): -1 at SemaphoreImpl.getAvailablePermits(Semaphore.kt:147)                                                                                    |                                                                                                                                                                                |
|     owner$volatile.get(): null at MutexImpl.unlock(Mutex.kt:210)                                                                                                                       |                                                                                                                                                                                |
|     owner$volatile.compareAndSet(null,<NO_OWNER>): true at MutexImpl.unlock(Mutex.kt:215)                                                                                              |                                                                                                                                                                                |
|     release() at MutexImpl.unlock(Mutex.kt:217)                                                                                                                                        |                                                                                                                                                                                |
|       _availablePermits$volatile.getAndIncrement(): -1 at SemaphoreImpl.release(Semaphore.kt:245)                                                                                      |                                                                                                                                                                                |
|       tryResumeNextFromQueue(): true at SemaphoreImpl.release(Semaphore.kt:260)                                                                                                        |                                                                                                                                                                                |
|         head$volatile.get(): SemaphoreSegment@1 at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:314)                                                                              |                                                                                                                                                                                |
|         deqIdx$volatile.getAndIncrement(): 0 at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:315)                                                                                 |                                                                                                                                                                                |
|         findSegmentInternal(SemaphoreSegment@1,0,createNewSegment$1): SemaphoreSegment@1 at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:441)                                     |                                                                                                                                                                                |
|           isRemoved(): false at ConcurrentLinkedListKt.findSegmentInternal(ConcurrentLinkedList.kt:22)                                                                                 |                                                                                                                                                                                |
|             cleanedAndPointers$volatile.get(): 131072 at Segment.isRemoved(ConcurrentLinkedList.kt:218)                                                                                |                                                                                                                                                                                |
|         head$volatile.get(): SemaphoreSegment@1 at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:442)                                                                              |                                                                                                                                                                                |
|         cleanPrev() at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:320)                                                                                                          |                                                                                                                                                                                |
|           _prev$volatile.set(null) at ConcurrentLinkedListNode.cleanPrev(ConcurrentLinkedList.kt:128)                                                                                  |                                                                                                                                                                                |
|         getAndSet(0,<PERMIT>): <cont> at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:451)                                                                                        |                                                                                                                                                                                |
|         tryResumeAcquire(<cont>): true at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:335)                                                                                       |                                                                                                                                                                                |
|           tryResume(Unit@1,null,onCancellationRelease$1): <RESUME_TOKEN> at SemaphoreImpl.tryResumeAcquire(Semaphore.kt:342)                                                           |                                                                                                                                                                                |
|             tryResume(Unit@1,null,onCancellationRelease$1): <RESUME_TOKEN> at MutexImpl$CancellableContinuationWithOwner.tryResume(Mutex.kt:245)                                       |                                                                                                                                                                                |
|               owner$volatile.get(): <NO_OWNER> at MutexImpl$CancellableContinuationWithOwner.tryResume(Mutex.kt:252)                                                                   |                                                                                                                                                                                |
|               tryResume(Unit@1,null,token$1): <RESUME_TOKEN> at MutexImpl$CancellableContinuationWithOwner.tryResume(Mutex.kt:253)                                                     |                                                                                                                                                                                |
|                 tryResumeImpl(Unit@1,null,token$1): <RESUME_TOKEN> at CancellableContinuationImpl.tryResume(CancellableContinuationImpl.kt:578)                                        |                                                                                                                                                                                |
|                   _state$volatile.get(): SemaphoreSegment@1 at CancellableContinuationImpl.tryResumeImpl(CancellableContinuationImpl.kt:528)                                           |                                                                                                                                                                                |
|                   _state$volatile.compareAndSet(SemaphoreSegment@1,CompletedContinuation@1): true at CancellableContinuationImpl.tryResumeImpl(CancellableContinuationImpl.kt:537)     |                                                                                                                                                                                |
|                   detachChildIfNonResuable() at CancellableContinuationImpl.tryResumeImpl(CancellableContinuationImpl.kt:538)                                                          |                                                                                                                                                                                |
|                     detachChild$kotlinx_coroutines_core() at CancellableContinuationImpl.detachChildIfNonResuable(CancellableContinuationImpl.kt:561)                                  |                                                                                                                                                                                |
|                       getParentHandle(): null at CancellableContinuationImpl.detachChild$kotlinx_coroutines_core(CancellableContinuationImpl.kt:568)                                   |                                                                                                                                                                                |
|                         _parentHandle$volatile.get(): null at CancellableContinuationImpl.getParentHandle(CancellableContinuationImpl.kt:102)                                          |                                                                                                                                                                                |
|               owner$volatile.get(): <NO_OWNER> at MutexImpl$CancellableContinuationWithOwner.tryResume(Mutex.kt:259)                                                                   |                                                                                                                                                                                |
|               owner$volatile.set(null) at MutexImpl$CancellableContinuationWithOwner.tryResume(Mutex.kt:260)                                                                           |                                                                                                                                                                                |
|           completeResume(<RESUME_TOKEN>) at SemaphoreImpl.tryResumeAcquire(Semaphore.kt:344)                                                                                           |                                                                                                                                                                                |
|             completeResume(<RESUME_TOKEN>) at MutexImpl$CancellableContinuationWithOwner.completeResume(Mutex.kt:0)                                                                    |                                                                                                                                                                                |
|               dispatchResume(1) at CancellableContinuationImpl.completeResume(CancellableContinuationImpl.kt:586)                                                                      |                                                                                                                                                                                |
|                 tryResume(): false at CancellableContinuationImpl.dispatchResume(CancellableContinuationImpl.kt:468)                                                                   |                                                                                                                                                                                |
|                   _decisionAndIndex$volatile.get(): 536870912 at CancellableContinuationImpl.tryResume(CancellableContinuationImpl.kt:281)                                             |                                                                                                                                                                                |
|                 dispatch(<cont>,1) at CancellableContinuationImpl.dispatchResume(CancellableContinuationImpl.kt:470)                                                                   |                                                                                                                                                                                |
|                   resume(<cont>,<cont>,false) at DispatchedTaskKt.dispatch(DispatchedTask.kt:164)                                                                                      |                                                                                                                                                                                |
|                     takeState$kotlinx_coroutines_core(): CompletedContinuation@1 at DispatchedTaskKt.resume(DispatchedTask.kt:170)                                                     |                                                                                                                                                                                |
|                       getState$kotlinx_coroutines_core(): CompletedContinuation@1 at CancellableContinuationImpl.takeState$kotlinx_coroutines_core(CancellableContinuationImpl.kt:164) |                                                                                                                                                                                |
|                         _state$volatile.get(): CompletedContinuation@1 at CancellableContinuationImpl.getState$kotlinx_coroutines_core(CancellableContinuationImpl.kt:104)             |                                                                                                                                                                                |
|   canEnterForbiddenBlock.READ: true at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:42)                                                                                  |                                                                                                                                                                                |
|   result: -1                                                                                                                                                                           |                                                                                                                                                                                |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
