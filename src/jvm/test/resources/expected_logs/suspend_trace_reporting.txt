= Invalid execution results =
| ----------------------------------- |
| Thread 1  |        Thread 2         |
| ----------------------------------- |
| bar(): -1 | foo(): SUSPENDED + void |
| ----------------------------------- |

The following interleaving leads to the error:
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                               Thread 1                                                |                                                             Thread 2                                                              |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| bar(): -1                                                                                             |                                                                                                                                   |
|   barStarted.WRITE(true) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:38)            |                                                                                                                                   |
|   lock(null): Unit#1 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:73)                |                                                                                                                                   |
|     lock$suspendImpl(MutexImpl#1,null,<cont>): Unit#1 at MutexImpl.lock(Mutex.kt:0)                   |                                                                                                                                   |
|       tryLock(null): true at MutexImpl.lock$suspendImpl(Mutex.kt:171)                                 |                                                                                                                                   |
|         tryLockImpl(null): 0 at MutexImpl.tryLock(Mutex.kt:183)                                       |                                                                                                                                   |
|           tryAcquire(): true at MutexImpl.tryLockImpl(Mutex.kt:189)                                   |                                                                                                                                   |
|           owner.get(): <NO_OWNER> at MutexImpl.tryLockImpl(Mutex.kt:190)                              |                                                                                                                                   |
|           switch                                                                                      |                                                                                                                                   |
|                                                                                                       | foo(): SUSPENDED + void                                                                                                           |
|                                                                                                       |   barStarted.READ: true at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29)                                         |
|                                                                                                       |   canEnterForbiddenBlock.WRITE(true) at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29)                            |
|                                                                                                       |   lock(null): COROUTINE_SUSPENDED at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:63)                               |
|                                                                                                       |     lock$suspendImpl(MutexImpl#1,null,<cont>): COROUTINE_SUSPENDED at MutexImpl.lock(Mutex.kt:0)                                  |
|                                                                                                       |       tryLock(null): false at MutexImpl.lock$suspendImpl(Mutex.kt:171)                                                            |
|                                                                                                       |       lockSuspend(null): COROUTINE_SUSPENDED at MutexImpl.lock$suspendImpl(Mutex.kt:172)                                          |
|                                                                                                       |         acquire(<cont>) at MutexImpl.lockSuspend(Mutex.kt:177)                                                                    |
|                                                                                                       |         getResult(): COROUTINE_SUSPENDED at MutexImpl.lockSuspend(Mutex.kt:321)                                                   |
|                                                                                                       |           trySuspend(): true at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:300)                         |
|                                                                                                       |           getParentHandle(): null at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:310)                    |
|                                                                                                       |           installParentHandle(): ChildContinuation#1 at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:311) |
|                                                                                                       |   switch (reason: coroutine is suspended)                                                                                         |
|                                                                                                       |   result: SUSPENDED + void                                                                                                        |
|           owner.set(null) at MutexImpl.tryLockImpl(Mutex.kt:191)                                      |                                                                                                                                   |
|   counter.READ: 0 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                   |                                                                                                                                   |
|   counter.WRITE(1) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                  |                                                                                                                                   |
|   unlock(null) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:77)                      |                                                                                                                                   |
|   canEnterForbiddenBlock.READ: true at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:42) |                                                                                                                                   |
|   result: -1                                                                                          |                                                                                                                                   |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

Detailed trace:
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                                                                        Thread 1                                                                                        |                                                                               Thread 2                                                                                |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| bar(): -1                                                                                                                                                                              |                                                                                                                                                                       |
|   barStarted.WRITE(true) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:38)                                                                                             |                                                                                                                                                                       |
|   lock(null): Unit#1 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:73)                                                                                                 |                                                                                                                                                                       |
|     lock$suspendImpl(MutexImpl#1,null,<cont>): Unit#1 at MutexImpl.lock(Mutex.kt:0)                                                                                                    |                                                                                                                                                                       |
|       tryLock(null): true at MutexImpl.lock$suspendImpl(Mutex.kt:171)                                                                                                                  |                                                                                                                                                                       |
|         tryLockImpl(null): 0 at MutexImpl.tryLock(Mutex.kt:183)                                                                                                                        |                                                                                                                                                                       |
|           tryAcquire(): true at MutexImpl.tryLockImpl(Mutex.kt:189)                                                                                                                    |                                                                                                                                                                       |
|             _availablePermits.get(): 1 at SemaphoreImpl.tryAcquire(Semaphore.kt:159)                                                                                                   |                                                                                                                                                                       |
|             _availablePermits.compareAndSet(1,0): true at SemaphoreImpl.tryAcquire(Semaphore.kt:171)                                                                                   |                                                                                                                                                                       |
|           owner.get(): <NO_OWNER> at MutexImpl.tryLockImpl(Mutex.kt:190)                                                                                                               |                                                                                                                                                                       |
|           switch                                                                                                                                                                       |                                                                                                                                                                       |
|                                                                                                                                                                                        | foo(): SUSPENDED + void                                                                                                                                               |
|                                                                                                                                                                                        |   barStarted.READ: true at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29)                                                                             |
|                                                                                                                                                                                        |   canEnterForbiddenBlock.WRITE(true) at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29)                                                                |
|                                                                                                                                                                                        |   lock(null): COROUTINE_SUSPENDED at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:63)                                                                   |
|                                                                                                                                                                                        |     lock$suspendImpl(MutexImpl#1,null,<cont>): COROUTINE_SUSPENDED at MutexImpl.lock(Mutex.kt:0)                                                                      |
|                                                                                                                                                                                        |       tryLock(null): false at MutexImpl.lock$suspendImpl(Mutex.kt:171)                                                                                                |
|                                                                                                                                                                                        |         tryLockImpl(null): 1 at MutexImpl.tryLock(Mutex.kt:183)                                                                                                       |
|                                                                                                                                                                                        |           tryAcquire(): false at MutexImpl.tryLockImpl(Mutex.kt:189)                                                                                                  |
|                                                                                                                                                                                        |             _availablePermits.get(): 0 at SemaphoreImpl.tryAcquire(Semaphore.kt:159)                                                                                  |
|                                                                                                                                                                                        |       lockSuspend(null): COROUTINE_SUSPENDED at MutexImpl.lock$suspendImpl(Mutex.kt:172)                                                                              |
|                                                                                                                                                                                        |         acquire(<cont>) at MutexImpl.lockSuspend(Mutex.kt:177)                                                                                                        |
|                                                                                                                                                                                        |           decPermits(): 0 at SemaphoreImpl.acquire(Semaphore.kt:413)                                                                                                  |
|                                                                                                                                                                                        |             _availablePermits.getAndDecrement(): 0 at SemaphoreImpl.decPermits(Semaphore.kt:237)                                                                      |
|                                                                                                                                                                                        |           addAcquireToQueue(<cont>): true at SemaphoreImpl.acquire(Semaphore.kt:199)                                                                                  |
|                                                                                                                                                                                        |             tail.get(): SemaphoreSegment#1 at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:286)                                                                       |
|                                                                                                                                                                                        |             enqIdx.getAndIncrement(): 0 at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:287)                                                                          |
|                                                                                                                                                                                        |             findSegmentInternal(SemaphoreSegment#1,0,createNewSegment$1): SemaphoreSegment#1 at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:432)                     |
|                                                                                                                                                                                        |               isRemoved(): false at ConcurrentLinkedListKt.findSegmentInternal(ConcurrentLinkedList.kt:26)                                                            |
|                                                                                                                                                                                        |                 cleanedAndPointers.get(): 131072 at Segment.isRemoved(ConcurrentLinkedList.kt:222)                                                                    |
|                                                                                                                                                                                        |             tail.get(): SemaphoreSegment#1 at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:433)                                                                       |
|                                                                                                                                                                                        |             compareAndSet(0,null,<cont>): true at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:442)                                                                   |
|                                                                                                                                                                                        |             invokeOnCancellation(SemaphoreSegment#1,0) at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:294)                                                           |
|                                                                                                                                                                                        |               invokeOnCancellation(SemaphoreSegment#1,0) at MutexImpl$CancellableContinuationWithOwner.invokeOnCancellation(Mutex.kt:0)                               |
|                                                                                                                                                                                        |                 _decisionAndIndex.get(): 536870911 at CancellableContinuationImpl.invokeOnCancellation(CancellableContinuationImpl.kt:0)                              |
|                                                                                                                                                                                        |                 _decisionAndIndex.compareAndSet(536870911,0): true at CancellableContinuationImpl.invokeOnCancellation(CancellableContinuationImpl.kt:392)            |
|                                                                                                                                                                                        |                 invokeOnCancellationImpl(SemaphoreSegment#1) at CancellableContinuationImpl.invokeOnCancellation(CancellableContinuationImpl.kt:394)                  |
|                                                                                                                                                                                        |                   _state.get(): Active#1 at CancellableContinuationImpl.invokeOnCancellationImpl(CancellableContinuationImpl.kt:403)                                  |
|                                                                                                                                                                                        |                   _state.compareAndSet(Active#1,SemaphoreSegment#1): true at CancellableContinuationImpl.invokeOnCancellationImpl(CancellableContinuationImpl.kt:407) |
|                                                                                                                                                                                        |         getResult(): COROUTINE_SUSPENDED at MutexImpl.lockSuspend(Mutex.kt:321)                                                                                       |
|                                                                                                                                                                                        |           trySuspend(): true at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:300)                                                             |
|                                                                                                                                                                                        |             _decisionAndIndex.get(): 0 at CancellableContinuationImpl.trySuspend(CancellableContinuationImpl.kt:0)                                                    |
|                                                                                                                                                                                        |             _decisionAndIndex.compareAndSet(0,536870912): true at CancellableContinuationImpl.trySuspend(CancellableContinuationImpl.kt:278)                          |
|                                                                                                                                                                                        |           getParentHandle(): null at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:310)                                                        |
|                                                                                                                                                                                        |             _parentHandle.get(): null at CancellableContinuationImpl.getParentHandle(CancellableContinuationImpl.kt:106)                                              |
|                                                                                                                                                                                        |           installParentHandle(): ChildContinuation#1 at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:311)                                     |
|                                                                                                                                                                                        |             _parentHandle.compareAndSet(null,ChildContinuation#1): true at CancellableContinuationImpl.installParentHandle(CancellableContinuationImpl.kt:352)        |
|                                                                                                                                                                                        |   switch (reason: coroutine is suspended)                                                                                                                             |
|                                                                                                                                                                                        |   result: SUSPENDED + void                                                                                                                                            |
|           owner.set(null) at MutexImpl.tryLockImpl(Mutex.kt:191)                                                                                                                       |                                                                                                                                                                       |
|   counter.READ: 0 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                                                                                                    |                                                                                                                                                                       |
|   counter.WRITE(1) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                                                                                                   |                                                                                                                                                                       |
|   unlock(null) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:77)                                                                                                       |                                                                                                                                                                       |
|     isLocked(): true at MutexImpl.unlock(Mutex.kt:213)                                                                                                                                 |                                                                                                                                                                       |
|       getAvailablePermits(): 0 at MutexImpl.isLocked(Mutex.kt:149)                                                                                                                     |                                                                                                                                                                       |
|         _availablePermits.get(): -1 at SemaphoreImpl.getAvailablePermits(Semaphore.kt:152)                                                                                             |                                                                                                                                                                       |
|     owner.get(): null at MutexImpl.unlock(Mutex.kt:215)                                                                                                                                |                                                                                                                                                                       |
|     owner.compareAndSet(null,<NO_OWNER>): true at MutexImpl.unlock(Mutex.kt:220)                                                                                                       |                                                                                                                                                                       |
|     release() at MutexImpl.unlock(Mutex.kt:222)                                                                                                                                        |                                                                                                                                                                       |
|       _availablePermits.getAndIncrement(): -1 at SemaphoreImpl.release(Semaphore.kt:250)                                                                                               |                                                                                                                                                                       |
|       tryResumeNextFromQueue(): true at SemaphoreImpl.release(Semaphore.kt:265)                                                                                                        |                                                                                                                                                                       |
|         head.get(): SemaphoreSegment#1 at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:319)                                                                                       |                                                                                                                                                                       |
|         deqIdx.getAndIncrement(): 0 at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:320)                                                                                          |                                                                                                                                                                       |
|         findSegmentInternal(SemaphoreSegment#1,0,createNewSegment$1): SemaphoreSegment#1 at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:446)                                     |                                                                                                                                                                       |
|           isRemoved(): false at ConcurrentLinkedListKt.findSegmentInternal(ConcurrentLinkedList.kt:26)                                                                                 |                                                                                                                                                                       |
|             cleanedAndPointers.get(): 131072 at Segment.isRemoved(ConcurrentLinkedList.kt:222)                                                                                         |                                                                                                                                                                       |
|         head.get(): SemaphoreSegment#1 at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:447)                                                                                       |                                                                                                                                                                       |
|         cleanPrev() at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:325)                                                                                                          |                                                                                                                                                                       |
|           _prev.lazySet(null) at ConcurrentLinkedListNode.cleanPrev(ConcurrentLinkedList.kt:132)                                                                                       |                                                                                                                                                                       |
|         getAndSet(0,<PERMIT>): <cont> at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:456)                                                                                        |                                                                                                                                                                       |
|         tryResumeAcquire(<cont>): true at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:340)                                                                                       |                                                                                                                                                                       |
|           tryResume(Unit#1,null,onCancellationRelease$1): <RESUME_TOKEN> at SemaphoreImpl.tryResumeAcquire(Semaphore.kt:347)                                                           |                                                                                                                                                                       |
|             tryResume(Unit#1,null,onCancellationRelease$1): <RESUME_TOKEN> at MutexImpl$CancellableContinuationWithOwner.tryResume(Mutex.kt:250)                                       |                                                                                                                                                                       |
|               owner.get(): <NO_OWNER> at MutexImpl$CancellableContinuationWithOwner.tryResume(Mutex.kt:257)                                                                            |                                                                                                                                                                       |
|               tryResume(Unit#1,null,token$1): <RESUME_TOKEN> at MutexImpl$CancellableContinuationWithOwner.tryResume(Mutex.kt:258)                                                     |                                                                                                                                                                       |
|                 tryResumeImpl(Unit#1,null,token$1): <RESUME_TOKEN> at CancellableContinuationImpl.tryResume(CancellableContinuationImpl.kt:582)                                        |                                                                                                                                                                       |
|                   _state.get(): SemaphoreSegment#1 at CancellableContinuationImpl.tryResumeImpl(CancellableContinuationImpl.kt:0)                                                      |                                                                                                                                                                       |
|                   _state.compareAndSet(SemaphoreSegment#1,CompletedContinuation#1): true at CancellableContinuationImpl.tryResumeImpl(CancellableContinuationImpl.kt:541)              |                                                                                                                                                                       |
|                   detachChildIfNonResuable() at CancellableContinuationImpl.tryResumeImpl(CancellableContinuationImpl.kt:542)                                                          |                                                                                                                                                                       |
|                     detachChild$kotlinx_coroutines_core() at CancellableContinuationImpl.detachChildIfNonResuable(CancellableContinuationImpl.kt:565)                                  |                                                                                                                                                                       |
|                       getParentHandle(): ChildContinuation#1 at CancellableContinuationImpl.detachChild$kotlinx_coroutines_core(CancellableContinuationImpl.kt:572)                    |                                                                                                                                                                       |
|                         _parentHandle.get(): ChildContinuation#1 at CancellableContinuationImpl.getParentHandle(CancellableContinuationImpl.kt:106)                                    |                                                                                                                                                                       |
|                       _parentHandle.set(NonDisposableHandle#1) at CancellableContinuationImpl.detachChild$kotlinx_coroutines_core(CancellableContinuationImpl.kt:574)                  |                                                                                                                                                                       |
|               owner.get(): <NO_OWNER> at MutexImpl$CancellableContinuationWithOwner.tryResume(Mutex.kt:264)                                                                            |                                                                                                                                                                       |
|               owner.set(null) at MutexImpl$CancellableContinuationWithOwner.tryResume(Mutex.kt:265)                                                                                    |                                                                                                                                                                       |
|           completeResume(<RESUME_TOKEN>) at SemaphoreImpl.tryResumeAcquire(Semaphore.kt:349)                                                                                           |                                                                                                                                                                       |
|             completeResume(<RESUME_TOKEN>) at MutexImpl$CancellableContinuationWithOwner.completeResume(Mutex.kt:0)                                                                    |                                                                                                                                                                       |
|               dispatchResume(1) at CancellableContinuationImpl.completeResume(CancellableContinuationImpl.kt:590)                                                                      |                                                                                                                                                                       |
|                 tryResume(): false at CancellableContinuationImpl.dispatchResume(CancellableContinuationImpl.kt:472)                                                                   |                                                                                                                                                                       |
|                   _decisionAndIndex.get(): 536870912 at CancellableContinuationImpl.tryResume(CancellableContinuationImpl.kt:0)                                                        |                                                                                                                                                                       |
|                 dispatch(<cont>,1) at CancellableContinuationImpl.dispatchResume(CancellableContinuationImpl.kt:474)                                                                   |                                                                                                                                                                       |
|                   resume(<cont>,<cont>,false) at DispatchedTaskKt.dispatch(DispatchedTask.kt:168)                                                                                      |                                                                                                                                                                       |
|                     takeState$kotlinx_coroutines_core(): CompletedContinuation#1 at DispatchedTaskKt.resume(DispatchedTask.kt:174)                                                     |                                                                                                                                                                       |
|                       getState$kotlinx_coroutines_core(): CompletedContinuation#1 at CancellableContinuationImpl.takeState$kotlinx_coroutines_core(CancellableContinuationImpl.kt:168) |                                                                                                                                                                       |
|                         _state.get(): CompletedContinuation#1 at CancellableContinuationImpl.getState$kotlinx_coroutines_core(CancellableContinuationImpl.kt:108)                      |                                                                                                                                                                       |
|   canEnterForbiddenBlock.READ: true at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:42)                                                                                  |                                                                                                                                                                       |
|   result: -1                                                                                                                                                                           |                                                                                                                                                                       |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
