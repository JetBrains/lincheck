= Invalid execution results =
| ----------------------------------- |
| Thread 1  |        Thread 2         |
| ----------------------------------- |
| bar(): -1 | foo(): SUSPENDED + void |
| ----------------------------------- |

The following interleaving leads to the error:
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                               Thread 1                                                |                                                Thread 2                                                |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| bar(): -1                                                                                             |                                                                                                        |
|   barStarted.WRITE(true) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:38)            |                                                                                                        |
|   lock(null): Unit@1 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:73)                |                                                                                                        |
|     lock$suspendImpl(MutexImpl@1,null,<cont>): Unit@1 at MutexImpl.lock(Mutex.kt:0)                   |                                                                                                        |
|       tryLock(null): true at MutexImpl.lock$suspendImpl(Mutex.kt:171)                                 |                                                                                                        |
|       switch                                                                                          |                                                                                                        |
|                                                                                                       | foo(): SUSPENDED + void                                                                                |
|                                                                                                       |   barStarted.READ: true at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29)              |
|                                                                                                       |   canEnterForbiddenBlock.WRITE(true) at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29) |
|                                                                                                       |   lock(null): CoroutineSingletons@1 at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:63)  |
|                                                                                                       |     lock$suspendImpl(MutexImpl@1,null,<cont>): CoroutineSingletons@1 at MutexImpl.lock(Mutex.kt:0)     |
|                                                                                                       |       tryLock(null): false at MutexImpl.lock$suspendImpl(Mutex.kt:171)                                 |
|                                                                                                       |       lockSuspend(null): CoroutineSingletons@1 at MutexImpl.lock$suspendImpl(Mutex.kt:172)             |
|                                                                                                       |         acquire(<cont>) at MutexImpl.lockSuspend(Mutex.kt:177)                                         |
|                                                                                                       |   switch (reason: coroutine is suspended)                                                              |
|                                                                                                       |   result: SUSPENDED + void                                                                             |
|       INSTANCE.READ: Unit@1 at MutexImpl.lock$suspendImpl(Mutex.kt:171)                               |                                                                                                        |
|   counter.READ: 0 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                   |                                                                                                        |
|   counter.WRITE(1) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                  |                                                                                                        |
|   unlock(null) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:77)                      |                                                                                                        |
|   canEnterForbiddenBlock.READ: true at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:42) |                                                                                                        |
|   result: -1                                                                                          |                                                                                                        |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

Detailed trace:
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                                                     Thread 1                                                                     |                                                Thread 2                                                |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| bar(): -1                                                                                                                                        |                                                                                                        |
|   barStarted.WRITE(true) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:38)                                                       |                                                                                                        |
|   lock(null): Unit@1 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:73)                                                           |                                                                                                        |
|     lock$suspendImpl(MutexImpl@1,null,<cont>): Unit@1 at MutexImpl.lock(Mutex.kt:0)                                                              |                                                                                                        |
|       tryLock(null): true at MutexImpl.lock$suspendImpl(Mutex.kt:171)                                                                            |                                                                                                        |
|         tryLockImpl(null): 0 at MutexImpl.tryLock(Mutex.kt:183)                                                                                  |                                                                                                        |
|           tryAcquire(): true at MutexImpl.tryLockImpl(Mutex.kt:189)                                                                              |                                                                                                        |
|             _availablePermits.get(): 1 at SemaphoreImpl.tryAcquire(Semaphore.kt:159)                                                             |                                                                                                        |
|             _availablePermits.compareAndSet(1,0): true at SemaphoreImpl.tryAcquire(Semaphore.kt:171)                                             |                                                                                                        |
|           owner.get(): <NO_OWNER> at MutexImpl.tryLockImpl(Mutex.kt:190)                                                                         |                                                                                                        |
|           owner.set(null) at MutexImpl.tryLockImpl(Mutex.kt:191)                                                                                 |                                                                                                        |
|       switch                                                                                                                                     |                                                                                                        |
|                                                                                                                                                  | foo(): SUSPENDED + void                                                                                |
|                                                                                                                                                  |   barStarted.READ: true at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29)              |
|                                                                                                                                                  |   canEnterForbiddenBlock.WRITE(true) at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29) |
|                                                                                                                                                  |   lock(null): CoroutineSingletons@1 at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:63)  |
|                                                                                                                                                  |     lock$suspendImpl(MutexImpl@1,null,<cont>): CoroutineSingletons@1 at MutexImpl.lock(Mutex.kt:0)     |
|                                                                                                                                                  |       tryLock(null): false at MutexImpl.lock$suspendImpl(Mutex.kt:171)                                 |
|                                                                                                                                                  |         tryLockImpl(null): 1 at MutexImpl.tryLock(Mutex.kt:183)                                        |
|                                                                                                                                                  |           tryAcquire(): false at MutexImpl.tryLockImpl(Mutex.kt:189)                                   |
|                                                                                                                                                  |             _availablePermits.get(): 0 at SemaphoreImpl.tryAcquire(Semaphore.kt:159)                   |
|                                                                                                                                                  |       lockSuspend(null): CoroutineSingletons@1 at MutexImpl.lock$suspendImpl(Mutex.kt:172)             |
|                                                                                                                                                  |         acquire(<cont>) at MutexImpl.lockSuspend(Mutex.kt:177)                                         |
|                                                                                                                                                  |           decPermits(): 0 at SemaphoreImpl.acquire(Semaphore.kt:413)                                   |
|                                                                                                                                                  |             _availablePermits.getAndDecrement(): 0 at SemaphoreImpl.decPermits(Semaphore.kt:237)       |
|                                                                                                                                                  |           addAcquireToQueue(<cont>): true at SemaphoreImpl.acquire(Semaphore.kt:199)                   |
|                                                                                                                                                  |             tail.get(): SemaphoreSegment@1 at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:286)        |
|                                                                                                                                                  |             enqIdx.getAndIncrement(): 0 at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:287)           |
|                                                                                                                                                  |             tail.get(): SemaphoreSegment@1 at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:433)        |
|                                                                                                                                                  |             compareAndSet(0,null,<cont>): true at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:442)    |
|                                                                                                                                                  |   switch (reason: coroutine is suspended)                                                              |
|                                                                                                                                                  |   result: SUSPENDED + void                                                                             |
|       INSTANCE.READ: Unit@1 at MutexImpl.lock$suspendImpl(Mutex.kt:171)                                                                          |                                                                                                        |
|   counter.READ: 0 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                                                              |                                                                                                        |
|   counter.WRITE(1) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                                                             |                                                                                                        |
|   unlock(null) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:77)                                                                 |                                                                                                        |
|     isLocked(): true at MutexImpl.unlock(Mutex.kt:213)                                                                                           |                                                                                                        |
|       getAvailablePermits(): 0 at MutexImpl.isLocked(Mutex.kt:149)                                                                               |                                                                                                        |
|         _availablePermits.get(): -1 at SemaphoreImpl.getAvailablePermits(Semaphore.kt:152)                                                       |                                                                                                        |
|     owner.get(): null at MutexImpl.unlock(Mutex.kt:215)                                                                                          |                                                                                                        |
|     owner.compareAndSet(null,<NO_OWNER>): true at MutexImpl.unlock(Mutex.kt:220)                                                                 |                                                                                                        |
|     release() at MutexImpl.unlock(Mutex.kt:222)                                                                                                  |                                                                                                        |
|       _availablePermits.getAndIncrement(): -1 at SemaphoreImpl.release(Semaphore.kt:250)                                                         |                                                                                                        |
|       tryResumeNextFromQueue(): true at SemaphoreImpl.release(Semaphore.kt:265)                                                                  |                                                                                                        |
|         head.get(): SemaphoreSegment@1 at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:319)                                                 |                                                                                                        |
|         deqIdx.getAndIncrement(): 0 at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:320)                                                    |                                                                                                        |
|         head.get(): SemaphoreSegment@1 at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:447)                                                 |                                                                                                        |
|         id.READ: 0 at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:326)                                                                     |                                                                                                        |
|         getAndSet(0,<PERMIT>): <cont> at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:456)                                                  |                                                                                                        |
|         tryResumeAcquire(<cont>): true at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:340)                                                 |                                                                                                        |
|           INSTANCE.READ: Unit@1 at SemaphoreImpl.tryResumeAcquire(Semaphore.kt:347)                                                              |                                                                                                        |
|           tryResume(Unit@1,null,onCancellationRelease$1): <RESUME_TOKEN> at SemaphoreImpl.tryResumeAcquire(Semaphore.kt:347)                     |                                                                                                        |
|             tryResume(Unit@1,null,onCancellationRelease$1): <RESUME_TOKEN> at MutexImpl$CancellableContinuationWithOwner.tryResume(Mutex.kt:250) |                                                                                                        |
|               owner.get(): <NO_OWNER> at MutexImpl$CancellableContinuationWithOwner.tryResume(Mutex.kt:257)                                      |                                                                                                        |
|               owner.get(): <NO_OWNER> at MutexImpl$CancellableContinuationWithOwner.tryResume(Mutex.kt:264)                                      |                                                                                                        |
|               owner.set(null) at MutexImpl$CancellableContinuationWithOwner.tryResume(Mutex.kt:265)                                              |                                                                                                        |
|   canEnterForbiddenBlock.READ: true at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:42)                                            |                                                                                                        |
|   result: -1                                                                                                                                     |                                                                                                        |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
