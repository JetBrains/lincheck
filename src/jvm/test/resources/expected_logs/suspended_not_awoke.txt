= Invalid execution results =
| ---------------------------------------- |
|    Thread 1     |        Thread 2        |
| ---------------------------------------- |
| trigger(): void | operation(): Suspended |
| ---------------------------------------- |

The following interleaving leads to the error:
| ---------------------------------------------------------------------------------------------------------------------------------------------------- |
|     Thread 1      |                                                             Thread 2                                                             |
| ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| trigger()         |                                                                                                                                  |
|   allowed = true  |                                                                                                                                  |
|   switch          |                                                                                                                                  |
|                   | operation(): Suspended                                                                                                           |
|                   |   allowed ➜ true                                                                                                                 |
|                   |   neverWakeUpChannel.receive() [suspendable: Continuation#1]: COROUTINE_SUSPENDED                                                |
|                   |     BufferedChannel.access$getReceiveSegment$FU$p(): AtomicReferenceFieldUpdaterImpl#1                                           |
|                   |     receiveSegment.get(): ChannelSegment#1                                                                                       |
|                   |     isClosedForReceive(): false                                                                                                  |
|                   |     BufferedChannel.access$getReceivers$FU$p(): CASUpdater#2                                                                     |
|                   |     receivers.getAndIncrement(): 0                                                                                               |
|                   |     BufferedChannel.updateCellReceive(ChannelSegment#1, 0, 0, null): <SUSPEND_NO_WAITER>                                         |
|                   |     BufferedChannelKt.access$getSUSPEND$p(): <SUSPEND>                                                                           |
|                   |     BufferedChannelKt.access$getFAILED$p(): <FAILED>                                                                             |
|                   |     BufferedChannelKt.access$getSUSPEND_NO_WAITER$p(): <SUSPEND_NO_WAITER>                                                       |
|                   |     receiveOnNoWaiterSuspend(ChannelSegment#1, 0, 0, Continuation#1): COROUTINE_SUSPENDED                                        |
|                   |       CancellableContinuationKt.getOrCreateCancellableContinuation(Continuation#1): Continuation#2                               |
|                   |       updateCellReceive(ChannelSegment#1, 0, 0, Continuation#2): <SUSPEND>                                                       |
|                   |       BufferedChannelKt.access$getSUSPEND$p(): <SUSPEND>                                                                         |
|                   |       prepareReceiverForSuspension(Continuation#2, ChannelSegment#1, 0)                                                          |
|                   |       cancellable.getResult(): COROUTINE_SUSPENDED                                                                               |
|                   |         isReusable(): false                                                                                                      |
|                   |         trySuspend(): true                                                                                                       |
|                   |         getParentHandle(): null                                                                                                  |
|                   |         installParentHandle(): ChildContinuation#1                                                                               |
|                   |           getContext(): CombinedContext#1                                                                                        |
|                   |           context.get(Key#1): JobImpl#1                                                                                          |
|                   |           Job.DefaultImpls.invokeOnCompletion$default(JobImpl#1, true, false, ChildContinuation#1, 2, null): ChildContinuation#1 |
|                   |           switch                                                                                                                 |
|   allowed = false |                                                                                                                                  |
|   result: void    |                                                                                                                                  |
|                   |           _parentHandle.compareAndSet(null, ChildContinuation#1): true                                                           |
|                   |       DebugProbesKt.probeCoroutineSuspended(Continuation#1)                                                                      |
|                   |   result: Suspended                                                                                                              |
| ---------------------------------------------------------------------------------------------------------------------------------------------------- |

Detailed trace:
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                    Thread 1                                     |                                                                                                        Thread 2                                                                                                         |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| trigger()                                                                       |                                                                                                                                                                                                                         |
|   allowed = true at SuspendedNotAwokeTest.trigger(SuspendedNotAwokeTest.kt:32)  |                                                                                                                                                                                                                         |
|   switch                                                                        |                                                                                                                                                                                                                         |
|                                                                                 | operation(): Suspended                                                                                                                                                                                                  |
|                                                                                 |   allowed ➜ true at SuspendedNotAwokeTest.operation(SuspendedNotAwokeTest.kt:38)                                                                                                                                        |
|                                                                                 |   neverWakeUpChannel.receive() [suspendable: Continuation#1]: COROUTINE_SUSPENDED at SuspendedNotAwokeTest.operation(SuspendedNotAwokeTest.kt:39)                                                                       |
|                                                                                 |     BufferedChannel.access$getReceiveSegment$FU$p(): AtomicReferenceFieldUpdaterImpl#1 at BufferedChannel.receive(BufferedChannel.kt:0)                                                                                 |
|                                                                                 |     receiveSegment.get(): ChannelSegment#1 at BufferedChannel.receive(BufferedChannel.kt:0)                                                                                                                             |
|                                                                                 |     isClosedForReceive(): false at BufferedChannel.receive(BufferedChannel.kt:0)                                                                                                                                        |
|                                                                                 |       sendersAndCloseStatus.get(): 0 at BufferedChannel.isClosedForReceive(BufferedChannel.kt:2188)                                                                                                                     |
|                                                                                 |       isClosedForReceive0(0): false at BufferedChannel.isClosedForReceive(BufferedChannel.kt:2188)                                                                                                                      |
|                                                                                 |         isClosed(0, true): false at BufferedChannel.isClosedForReceive0(BufferedChannel.kt:2191)                                                                                                                        |
|                                                                                 |     BufferedChannel.access$getReceivers$FU$p(): CASUpdater#2 at BufferedChannel.receive(BufferedChannel.kt:0)                                                                                                           |
|                                                                                 |     receivers.getAndIncrement(): 0 at BufferedChannel.receive(BufferedChannel.kt:0)                                                                                                                                     |
|                                                                                 |     BufferedChannel.updateCellReceive(ChannelSegment#1, 0, 0, null): <SUSPEND_NO_WAITER> at BufferedChannel.receive(BufferedChannel.kt:0)                                                                               |
|                                                                                 |       segment.getState(0): null at BufferedChannel.updateCellReceive(BufferedChannel.kt:999)                                                                                                                            |
|                                                                                 |         data[1].get(): null at ChannelSegment.getState(BufferedChannel.kt:2773)                                                                                                                                         |
|                                                                                 |       sendersAndCloseStatus.get(): 0 at BufferedChannel.updateCellReceive(BufferedChannel.kt:1007)                                                                                                                      |
|                                                                                 |       BufferedChannelKt.access$getSUSPEND_NO_WAITER$p(): <SUSPEND_NO_WAITER> at BufferedChannel.updateCellReceive(BufferedChannel.kt:1013)                                                                              |
|                                                                                 |     BufferedChannelKt.access$getSUSPEND$p(): <SUSPEND> at BufferedChannel.receive(BufferedChannel.kt:0)                                                                                                                 |
|                                                                                 |     BufferedChannelKt.access$getFAILED$p(): <FAILED> at BufferedChannel.receive(BufferedChannel.kt:0)                                                                                                                   |
|                                                                                 |     BufferedChannelKt.access$getSUSPEND_NO_WAITER$p(): <SUSPEND_NO_WAITER> at BufferedChannel.receive(BufferedChannel.kt:0)                                                                                             |
|                                                                                 |     receiveOnNoWaiterSuspend(ChannelSegment#1, 0, 0, Continuation#1): COROUTINE_SUSPENDED at BufferedChannel.receive(BufferedChannel.kt:0)                                                                              |
|                                                                                 |       CancellableContinuationKt.getOrCreateCancellableContinuation(Continuation#1): Continuation#2 at BufferedChannel.receiveOnNoWaiterSuspend(BufferedChannel.kt:3572)                                                 |
|                                                                                 |       updateCellReceive(ChannelSegment#1, 0, 0, Continuation#2): <SUSPEND> at BufferedChannel.receiveOnNoWaiterSuspend(BufferedChannel.kt:3575)                                                                         |
|                                                                                 |         segment.getState(0): null at BufferedChannel.updateCellReceive(BufferedChannel.kt:999)                                                                                                                          |
|                                                                                 |           data[1].get(): null at ChannelSegment.getState(BufferedChannel.kt:2773)                                                                                                                                       |
|                                                                                 |         sendersAndCloseStatus.get(): 0 at BufferedChannel.updateCellReceive(BufferedChannel.kt:1007)                                                                                                                    |
|                                                                                 |         segment.casState(0, null, Continuation#2): true at BufferedChannel.updateCellReceive(BufferedChannel.kt:1016)                                                                                                   |
|                                                                                 |           data[1].compareAndSet(null, Continuation#2): true at ChannelSegment.casState(BufferedChannel.kt:2779)                                                                                                         |
|                                                                                 |         expandBuffer() at BufferedChannel.updateCellReceive(BufferedChannel.kt:1019)                                                                                                                                    |
|                                                                                 |           isRendezvousOrUnlimited(): true at BufferedChannel.expandBuffer(BufferedChannel.kt:1173)                                                                                                                      |
|                                                                                 |             getBufferEndCounter(): 0 at BufferedChannel.isRendezvousOrUnlimited(BufferedChannel.kt:90)                                                                                                                  |
|                                                                                 |               bufferEnd.get(): 0 at BufferedChannel.getBufferEndCounter(BufferedChannel.kt:72)                                                                                                                          |
|                                                                                 |         BufferedChannelKt.access$getSUSPEND$p(): <SUSPEND> at BufferedChannel.updateCellReceive(BufferedChannel.kt:1020)                                                                                                |
|                                                                                 |       BufferedChannelKt.access$getSUSPEND$p(): <SUSPEND> at BufferedChannel.receiveOnNoWaiterSuspend(BufferedChannel.kt:3577)                                                                                           |
|                                                                                 |       prepareReceiverForSuspension(Continuation#2, ChannelSegment#1, 0) at BufferedChannel.receiveOnNoWaiterSuspend(BufferedChannel.kt:3578)                                                                            |
|                                                                                 |         onReceiveEnqueued() at BufferedChannel.prepareReceiverForSuspension(BufferedChannel.kt:716)                                                                                                                     |
|                                                                                 |         $this$prepareReceiverForSuspension.invokeOnCancellation(ChannelSegment#1, 0) at BufferedChannel.prepareReceiverForSuspension(BufferedChannel.kt:717)                                                            |
|                                                                                 |           _decisionAndIndex.get(): 536870911 at CancellableContinuationImpl.invokeOnCancellation(CancellableContinuationImpl.kt:0)                                                                                      |
|                                                                                 |           _decisionAndIndex.compareAndSet(536870911, 0): true at CancellableContinuationImpl.invokeOnCancellation(CancellableContinuationImpl.kt:392)                                                                   |
|                                                                                 |           invokeOnCancellationImpl(ChannelSegment#1) at CancellableContinuationImpl.invokeOnCancellation(CancellableContinuationImpl.kt:394)                                                                            |
|                                                                                 |             DebugKt.getASSERTIONS_ENABLED(): true at CancellableContinuationImpl.invokeOnCancellationImpl(CancellableContinuationImpl.kt:403)                                                                           |
|                                                                                 |             _state.get(): Active#1 at CancellableContinuationImpl.invokeOnCancellationImpl(CancellableContinuationImpl.kt:403)                                                                                          |
|                                                                                 |             _state.compareAndSet(Active#1, ChannelSegment#1): true at CancellableContinuationImpl.invokeOnCancellationImpl(CancellableContinuationImpl.kt:407)                                                          |
|                                                                                 |       cancellable.getResult(): COROUTINE_SUSPENDED at BufferedChannel.receiveOnNoWaiterSuspend(BufferedChannel.kt:3648)                                                                                                 |
|                                                                                 |         isReusable(): false at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:297)                                                                                                                |
|                                                                                 |           resumeMode ➜ 1 at CancellableContinuationImpl.isReusable(CancellableContinuationImpl.kt:141)                                                                                                                  |
|                                                                                 |           DispatchedTaskKt.isReusableMode(1): false at CancellableContinuationImpl.isReusable(CancellableContinuationImpl.kt:141)                                                                                       |
|                                                                                 |         trySuspend(): true at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:300)                                                                                                                 |
|                                                                                 |           _decisionAndIndex.get(): 0 at CancellableContinuationImpl.trySuspend(CancellableContinuationImpl.kt:0)                                                                                                        |
|                                                                                 |           _decisionAndIndex.compareAndSet(0, 536870912): true at CancellableContinuationImpl.trySuspend(CancellableContinuationImpl.kt:278)                                                                             |
|                                                                                 |         getParentHandle(): null at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:310)                                                                                                            |
|                                                                                 |           _parentHandle.get(): null at CancellableContinuationImpl.getParentHandle(CancellableContinuationImpl.kt:106)                                                                                                  |
|                                                                                 |         installParentHandle(): ChildContinuation#1 at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:311)                                                                                         |
|                                                                                 |           getContext(): CombinedContext#1 at CancellableContinuationImpl.installParentHandle(CancellableContinuationImpl.kt:346)                                                                                        |
|                                                                                 |           context.get(Key#1): JobImpl#1 at CancellableContinuationImpl.installParentHandle(CancellableContinuationImpl.kt:346)                                                                                          |
|                                                                                 |             CoroutineContext.Element.DefaultImpls.get(JobImpl#1, Key#1): JobImpl#1 at Job.DefaultImpls.get(Job.kt:112)                                                                                                  |
|                                                                                 |               getKey(): Key#1 at CoroutineContext.Element.DefaultImpls.get(CoroutineContext.kt:67)                                                                                                                      |
|                                                                                 |           Job.DefaultImpls.invokeOnCompletion$default(JobImpl#1, true, false, ChildContinuation#1, 2, null): ChildContinuation#1 at CancellableContinuationImpl.installParentHandle(CancellableContinuationImpl.kt:348) |
|                                                                                 |             JobImpl#1.invokeOnCompletion(true, true, ChildContinuation#1): ChildContinuation#1 at Job.DefaultImpls.invokeOnCompletion$default(Job.kt:357)                                                               |
|                                                                                 |           switch                                                                                                                                                                                                        |
|   allowed = false at SuspendedNotAwokeTest.trigger(SuspendedNotAwokeTest.kt:33) |                                                                                                                                                                                                                         |
|   result: void                                                                  |                                                                                                                                                                                                                         |
|                                                                                 |           _parentHandle.compareAndSet(null, ChildContinuation#1): true at CancellableContinuationImpl.installParentHandle(CancellableContinuationImpl.kt:352)                                                           |
|                                                                                 |       DebugProbesKt.probeCoroutineSuspended(Continuation#1) at BufferedChannel.receiveOnNoWaiterSuspend(BufferedChannel.kt:3571)                                                                                        |
|                                                                                 |   result: Suspended                                                                                                                                                                                                     |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
