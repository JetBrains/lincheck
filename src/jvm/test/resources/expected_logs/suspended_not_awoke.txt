= Invalid execution results =
| ---------------------------------------- |
|    Thread 1     |        Thread 2        |
| ---------------------------------------- |
| trigger(): void | operation(): Suspended |
| ---------------------------------------- |

The following interleaving leads to the error:
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                       Thread 1                                       |                                                                                                       Thread 2                                                                                                       |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| trigger()                                                                            |                                                                                                                                                                                                                      |
|   allowed.WRITE(true) at SuspendedNotAwokeTest.trigger(SuspendedNotAwokeTest.kt:31)  |                                                                                                                                                                                                                      |
|   switch                                                                             |                                                                                                                                                                                                                      |
|                                                                                      | operation(): Suspended                                                                                                                                                                                               |
|                                                                                      |   allowed.READ: true at SuspendedNotAwokeTest.operation(SuspendedNotAwokeTest.kt:37)                                                                                                                                 |
|                                                                                      |   neverWakeUpChannel.receive(<cont>): COROUTINE_SUSPENDED at SuspendedNotAwokeTest.operation(SuspendedNotAwokeTest.kt:38)                                                                                            |
|                                                                                      |     BufferedChannel.receive$suspendImpl(BufferedChannel#1,<cont>): COROUTINE_SUSPENDED at BufferedChannel.receive(BufferedChannel.kt:0)                                                                              |
|                                                                                      |       receiveSegment.get(): ChannelSegment#1 at BufferedChannel.receive$suspendImpl(BufferedChannel.kt:3519)                                                                                                         |
|                                                                                      |       SuspendedNotAwokeTest#1.neverWakeUpChannel.isClosedForReceive(): false at BufferedChannel.receive$suspendImpl(BufferedChannel.kt:3523)                                                                         |
|                                                                                      |       receivers.getAndIncrement(): 0 at BufferedChannel.receive$suspendImpl(BufferedChannel.kt:3526)                                                                                                                 |
|                                                                                      |       BufferedChannel.access$updateCellReceive(BufferedChannel#1,ChannelSegment#1,0,0,null): <SUSPEND_NO_WAITER> at BufferedChannel.receive$suspendImpl(BufferedChannel.kt:3541)                                     |
|                                                                                      |       SuspendedNotAwokeTest#1.neverWakeUpChannel.receiveOnNoWaiterSuspend(ChannelSegment#1,0,0,<cont>): COROUTINE_SUSPENDED at BufferedChannel.receive$suspendImpl(BufferedChannel.kt:685)                           |
|                                                                                      |         BufferedChannel.access$updateCellReceive(BufferedChannel#1,ChannelSegment#1,0,0,<cont>): <SUSPEND> at BufferedChannel.receiveOnNoWaiterSuspend(BufferedChannel.kt:3575)                                      |
|                                                                                      |         BufferedChannel.access$prepareReceiverForSuspension(BufferedChannel#1,<cont>,ChannelSegment#1,0) at BufferedChannel.receiveOnNoWaiterSuspend(BufferedChannel.kt:3578)                                        |
|                                                                                      |         <cont>.getResult(): COROUTINE_SUSPENDED at BufferedChannel.receiveOnNoWaiterSuspend(BufferedChannel.kt:3648)                                                                                                 |
|                                                                                      |           trySuspend(): true at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:300)                                                                                                            |
|                                                                                      |           getParentHandle(): null at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:310)                                                                                                       |
|                                                                                      |           installParentHandle(): ChildContinuation#1 at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:311)                                                                                    |
|                                                                                      |             Job$DefaultImpls.invokeOnCompletion$default(JobImpl#1,true,false,ChildContinuation#1,2,null): ChildContinuation#1 at CancellableContinuationImpl.installParentHandle(CancellableContinuationImpl.kt:348) |
|                                                                                      |               JobImpl#1.invokeOnCompletion(true,true,ChildContinuation#1): ChildContinuation#1 at Job$DefaultImpls.invokeOnCompletion$default(Job.kt:357)                                                            |
|                                                                                      |                 _prev.lazySet(ChildContinuation#2) at LockFreeLinkedListNode.addOneIfEmpty(LockFreeLinkedList.kt:106)                                                                                                |
|                                                                                      |                 _next.lazySet(ChildContinuation#2) at LockFreeLinkedListNode.addOneIfEmpty(LockFreeLinkedList.kt:107)                                                                                                |
|                                                                                      |                 ChildContinuation#2.getNext(): ChildContinuation#2 at LockFreeLinkedListNode.addOneIfEmpty(LockFreeLinkedList.kt:109)                                                                                |
|                                                                                      |                 switch                                                                                                                                                                                               |
|   allowed.WRITE(false) at SuspendedNotAwokeTest.trigger(SuspendedNotAwokeTest.kt:32) |                                                                                                                                                                                                                      |
|   result: void                                                                       |                                                                                                                                                                                                                      |
|                                                                                      |                 _next.compareAndSet(ChildContinuation#2,NodeList#1): true at LockFreeLinkedListNode.addOneIfEmpty(LockFreeLinkedList.kt:111)                                                                         |
|                                                                                      |                 NodeList#1.finishAdd(ChildContinuation#2) at LockFreeLinkedListNode.addOneIfEmpty(LockFreeLinkedList.kt:113)                                                                                         |
|                                                                                      |                 ChildContinuation#2.getNext(): NodeList#1 at LockFreeLinkedListNode.getNextNode(LockFreeLinkedList.kt:88)                                                                                            |
|                                                                                      |                 NodeList#1.correctPrev(null): ChildContinuation#2 at LockFreeLinkedListNode.getPrevNode(LockFreeLinkedList.kt:96)                                                                                    |
|                                                                                      |                 _prev.lazySet(ChildContinuation#2) at LockFreeLinkedListNode.tryCondAddNext(LockFreeLinkedList.kt:182)                                                                                               |
|                                                                                      |                 _next.lazySet(NodeList#1) at LockFreeLinkedListNode.tryCondAddNext(LockFreeLinkedList.kt:183)                                                                                                        |
|                                                                                      |                 addLastIf$1.oldNext.WRITE(NodeList#1) at LockFreeLinkedListNode.tryCondAddNext(LockFreeLinkedList.kt:184)                                                                                            |
|                                                                                      |                 _next.compareAndSet(NodeList#1,addLastIf$1): true at LockFreeLinkedListNode.tryCondAddNext(LockFreeLinkedList.kt:185)                                                                                |
|                                                                                      |                 addLastIf$1.perform(ChildContinuation#2): null at LockFreeLinkedListNode.tryCondAddNext(LockFreeLinkedList.kt:187)                                                                                   |
|                                                                                      |             _parentHandle.compareAndSet(null,ChildContinuation#1): true at CancellableContinuationImpl.installParentHandle(CancellableContinuationImpl.kt:352)                                                       |
|                                                                                      |   result: Suspended                                                                                                                                                                                                  |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

Detailed trace:
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                       Thread 1                                       |                                                                                                       Thread 2                                                                                                       |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| trigger()                                                                            |                                                                                                                                                                                                                      |
|   allowed.WRITE(true) at SuspendedNotAwokeTest.trigger(SuspendedNotAwokeTest.kt:31)  |                                                                                                                                                                                                                      |
|   switch                                                                             |                                                                                                                                                                                                                      |
|                                                                                      | operation(): Suspended                                                                                                                                                                                               |
|                                                                                      |   allowed.READ: true at SuspendedNotAwokeTest.operation(SuspendedNotAwokeTest.kt:37)                                                                                                                                 |
|                                                                                      |   neverWakeUpChannel.receive(<cont>): COROUTINE_SUSPENDED at SuspendedNotAwokeTest.operation(SuspendedNotAwokeTest.kt:38)                                                                                            |
|                                                                                      |     BufferedChannel.receive$suspendImpl(BufferedChannel#1,<cont>): COROUTINE_SUSPENDED at BufferedChannel.receive(BufferedChannel.kt:0)                                                                              |
|                                                                                      |       receiveSegment.get(): ChannelSegment#1 at BufferedChannel.receive$suspendImpl(BufferedChannel.kt:3519)                                                                                                         |
|                                                                                      |       SuspendedNotAwokeTest#1.neverWakeUpChannel.isClosedForReceive(): false at BufferedChannel.receive$suspendImpl(BufferedChannel.kt:3523)                                                                         |
|                                                                                      |         sendersAndCloseStatus.get(): 0 at BufferedChannel.isClosedForReceive(BufferedChannel.kt:2188)                                                                                                                |
|                                                                                      |       receivers.getAndIncrement(): 0 at BufferedChannel.receive$suspendImpl(BufferedChannel.kt:3526)                                                                                                                 |
|                                                                                      |       BufferedChannel.access$updateCellReceive(BufferedChannel#1,ChannelSegment#1,0,0,null): <SUSPEND_NO_WAITER> at BufferedChannel.receive$suspendImpl(BufferedChannel.kt:3541)                                     |
|                                                                                      |         SuspendedNotAwokeTest#1.neverWakeUpChannel.updateCellReceive(ChannelSegment#1,0,0,null): <SUSPEND_NO_WAITER> at BufferedChannel.access$updateCellReceive(BufferedChannel.kt:36)                              |
|                                                                                      |           ChannelSegment#1.getState$kotlinx_coroutines_core(0): null at BufferedChannel.updateCellReceive(BufferedChannel.kt:999)                                                                                    |
|                                                                                      |             data[1].get(): null at ChannelSegment.getState$kotlinx_coroutines_core(BufferedChannel.kt:2773)                                                                                                          |
|                                                                                      |           sendersAndCloseStatus.get(): 0 at BufferedChannel.updateCellReceive(BufferedChannel.kt:1007)                                                                                                               |
|                                                                                      |       SuspendedNotAwokeTest#1.neverWakeUpChannel.receiveOnNoWaiterSuspend(ChannelSegment#1,0,0,<cont>): COROUTINE_SUSPENDED at BufferedChannel.receive$suspendImpl(BufferedChannel.kt:685)                           |
|                                                                                      |         BufferedChannel.access$updateCellReceive(BufferedChannel#1,ChannelSegment#1,0,0,<cont>): <SUSPEND> at BufferedChannel.receiveOnNoWaiterSuspend(BufferedChannel.kt:3575)                                      |
|                                                                                      |           SuspendedNotAwokeTest#1.neverWakeUpChannel.updateCellReceive(ChannelSegment#1,0,0,<cont>): <SUSPEND> at BufferedChannel.access$updateCellReceive(BufferedChannel.kt:36)                                    |
|                                                                                      |             ChannelSegment#1.getState$kotlinx_coroutines_core(0): null at BufferedChannel.updateCellReceive(BufferedChannel.kt:999)                                                                                  |
|                                                                                      |               data[1].get(): null at ChannelSegment.getState$kotlinx_coroutines_core(BufferedChannel.kt:2773)                                                                                                        |
|                                                                                      |             sendersAndCloseStatus.get(): 0 at BufferedChannel.updateCellReceive(BufferedChannel.kt:1007)                                                                                                             |
|                                                                                      |             ChannelSegment#1.casState$kotlinx_coroutines_core(0,null,<cont>): true at BufferedChannel.updateCellReceive(BufferedChannel.kt:1016)                                                                     |
|                                                                                      |               data[1].compareAndSet(null,<cont>): true at ChannelSegment.casState$kotlinx_coroutines_core(BufferedChannel.kt:2779)                                                                                   |
|                                                                                      |             expandBuffer() at BufferedChannel.updateCellReceive(BufferedChannel.kt:1019)                                                                                                                             |
|                                                                                      |               isRendezvousOrUnlimited(): true at BufferedChannel.expandBuffer(BufferedChannel.kt:1173)                                                                                                               |
|                                                                                      |                 getBufferEndCounter(): 0 at BufferedChannel.isRendezvousOrUnlimited(BufferedChannel.kt:90)                                                                                                           |
|                                                                                      |                   bufferEnd.get(): 0 at BufferedChannel.getBufferEndCounter(BufferedChannel.kt:72)                                                                                                                   |
|                                                                                      |         BufferedChannel.access$prepareReceiverForSuspension(BufferedChannel#1,<cont>,ChannelSegment#1,0) at BufferedChannel.receiveOnNoWaiterSuspend(BufferedChannel.kt:3578)                                        |
|                                                                                      |           SuspendedNotAwokeTest#1.neverWakeUpChannel.prepareReceiverForSuspension(<cont>,ChannelSegment#1,0) at BufferedChannel.access$prepareReceiverForSuspension(BufferedChannel.kt:36)                           |
|                                                                                      |             <cont>.invokeOnCancellation(ChannelSegment#1,0) at BufferedChannel.prepareReceiverForSuspension(BufferedChannel.kt:717)                                                                                  |
|                                                                                      |               _decisionAndIndex.get(): 536870911 at CancellableContinuationImpl.invokeOnCancellation(CancellableContinuationImpl.kt:0)                                                                               |
|                                                                                      |               _decisionAndIndex.compareAndSet(536870911,0): true at CancellableContinuationImpl.invokeOnCancellation(CancellableContinuationImpl.kt:392)                                                             |
|                                                                                      |               invokeOnCancellationImpl(ChannelSegment#1) at CancellableContinuationImpl.invokeOnCancellation(CancellableContinuationImpl.kt:394)                                                                     |
|                                                                                      |                 _state.get(): Active#1 at CancellableContinuationImpl.invokeOnCancellationImpl(CancellableContinuationImpl.kt:403)                                                                                   |
|                                                                                      |                 _state.compareAndSet(Active#1,ChannelSegment#1): true at CancellableContinuationImpl.invokeOnCancellationImpl(CancellableContinuationImpl.kt:407)                                                    |
|                                                                                      |         <cont>.getResult(): COROUTINE_SUSPENDED at BufferedChannel.receiveOnNoWaiterSuspend(BufferedChannel.kt:3648)                                                                                                 |
|                                                                                      |           trySuspend(): true at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:300)                                                                                                            |
|                                                                                      |             _decisionAndIndex.get(): 0 at CancellableContinuationImpl.trySuspend(CancellableContinuationImpl.kt:0)                                                                                                   |
|                                                                                      |             _decisionAndIndex.compareAndSet(0,536870912): true at CancellableContinuationImpl.trySuspend(CancellableContinuationImpl.kt:278)                                                                         |
|                                                                                      |           getParentHandle(): null at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:310)                                                                                                       |
|                                                                                      |             _parentHandle.get(): null at CancellableContinuationImpl.getParentHandle(CancellableContinuationImpl.kt:106)                                                                                             |
|                                                                                      |           installParentHandle(): ChildContinuation#1 at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:311)                                                                                    |
|                                                                                      |             Job$DefaultImpls.invokeOnCompletion$default(JobImpl#1,true,false,ChildContinuation#1,2,null): ChildContinuation#1 at CancellableContinuationImpl.installParentHandle(CancellableContinuationImpl.kt:348) |
|                                                                                      |               JobImpl#1.invokeOnCompletion(true,true,ChildContinuation#1): ChildContinuation#1 at Job$DefaultImpls.invokeOnCompletion$default(Job.kt:357)                                                            |
|                                                                                      |                 _prev.lazySet(ChildContinuation#2) at LockFreeLinkedListNode.addOneIfEmpty(LockFreeLinkedList.kt:106)                                                                                                |
|                                                                                      |                 _next.lazySet(ChildContinuation#2) at LockFreeLinkedListNode.addOneIfEmpty(LockFreeLinkedList.kt:107)                                                                                                |
|                                                                                      |                 ChildContinuation#2.getNext(): ChildContinuation#2 at LockFreeLinkedListNode.addOneIfEmpty(LockFreeLinkedList.kt:109)                                                                                |
|                                                                                      |                   _next.get(): ChildContinuation#2 at LockFreeLinkedListNode.getNext(LockFreeLinkedList.kt:0)                                                                                                        |
|                                                                                      |                 switch                                                                                                                                                                                               |
|   allowed.WRITE(false) at SuspendedNotAwokeTest.trigger(SuspendedNotAwokeTest.kt:32) |                                                                                                                                                                                                                      |
|   result: void                                                                       |                                                                                                                                                                                                                      |
|                                                                                      |                 _next.compareAndSet(ChildContinuation#2,NodeList#1): true at LockFreeLinkedListNode.addOneIfEmpty(LockFreeLinkedList.kt:111)                                                                         |
|                                                                                      |                 NodeList#1.finishAdd(ChildContinuation#2) at LockFreeLinkedListNode.addOneIfEmpty(LockFreeLinkedList.kt:113)                                                                                         |
|                                                                                      |                   _prev.get(): ChildContinuation#2 at LockFreeLinkedListNode.finishAdd(LockFreeLinkedList.kt:0)                                                                                                      |
|                                                                                      |                   getNext(): ChildContinuation#2 at LockFreeLinkedListNode.finishAdd(LockFreeLinkedList.kt:248)                                                                                                      |
|                                                                                      |                     _next.get(): ChildContinuation#2 at LockFreeLinkedListNode.getNext(LockFreeLinkedList.kt:0)                                                                                                      |
|                                                                                      |                   _prev.compareAndSet(ChildContinuation#2,NodeList#1): true at LockFreeLinkedListNode.finishAdd(LockFreeLinkedList.kt:249)                                                                           |
|                                                                                      |                 ChildContinuation#2.getNext(): NodeList#1 at LockFreeLinkedListNode.getNextNode(LockFreeLinkedList.kt:88)                                                                                            |
|                                                                                      |                   _next.get(): NodeList#1 at LockFreeLinkedListNode.getNext(LockFreeLinkedList.kt:0)                                                                                                                 |
|                                                                                      |                 NodeList#1.correctPrev(null): ChildContinuation#2 at LockFreeLinkedListNode.getPrevNode(LockFreeLinkedList.kt:96)                                                                                    |
|                                                                                      |                   _prev.get(): ChildContinuation#2 at LockFreeLinkedListNode.correctPrev(LockFreeLinkedList.kt:271)                                                                                                  |
|                                                                                      |                   _next.get(): NodeList#1 at LockFreeLinkedListNode.correctPrev(LockFreeLinkedList.kt:275)                                                                                                           |
|                                                                                      |                 _prev.lazySet(ChildContinuation#2) at LockFreeLinkedListNode.tryCondAddNext(LockFreeLinkedList.kt:182)                                                                                               |
|                                                                                      |                 _next.lazySet(NodeList#1) at LockFreeLinkedListNode.tryCondAddNext(LockFreeLinkedList.kt:183)                                                                                                        |
|                                                                                      |                 addLastIf$1.oldNext.WRITE(NodeList#1) at LockFreeLinkedListNode.tryCondAddNext(LockFreeLinkedList.kt:184)                                                                                            |
|                                                                                      |                 _next.compareAndSet(NodeList#1,addLastIf$1): true at LockFreeLinkedListNode.tryCondAddNext(LockFreeLinkedList.kt:185)                                                                                |
|                                                                                      |                 addLastIf$1.perform(ChildContinuation#2): null at LockFreeLinkedListNode.tryCondAddNext(LockFreeLinkedList.kt:187)                                                                                   |
|                                                                                      |                   ChildContinuation#1.finishAdd(NodeList#1) at LockFreeLinkedListNode.access$finishAdd(LockFreeLinkedList.kt:45)                                                                                     |
|                                                                                      |                     _prev.get(): ChildContinuation#2 at LockFreeLinkedListNode.finishAdd(LockFreeLinkedList.kt:0)                                                                                                    |
|                                                                                      |                     getNext(): NodeList#1 at LockFreeLinkedListNode.finishAdd(LockFreeLinkedList.kt:248)                                                                                                             |
|                                                                                      |                       _next.get(): NodeList#1 at LockFreeLinkedListNode.getNext(LockFreeLinkedList.kt:0)                                                                                                             |
|                                                                                      |                     _prev.compareAndSet(ChildContinuation#2,ChildContinuation#1): true at LockFreeLinkedListNode.finishAdd(LockFreeLinkedList.kt:249)                                                                |
|                                                                                      |                     isRemoved(): false at LockFreeLinkedListNode.finishAdd(LockFreeLinkedList.kt:252)                                                                                                                |
|                                                                                      |                       getNext(): NodeList#1 at LockFreeLinkedListNode.isRemoved(LockFreeLinkedList.kt:77)                                                                                                            |
|                                                                                      |                         _next.get(): NodeList#1 at LockFreeLinkedListNode.getNext(LockFreeLinkedList.kt:0)                                                                                                           |
|                                                                                      |             _parentHandle.compareAndSet(null,ChildContinuation#1): true at CancellableContinuationImpl.installParentHandle(CancellableContinuationImpl.kt:352)                                                       |
|                                                                                      |   result: Suspended                                                                                                                                                                                                  |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
