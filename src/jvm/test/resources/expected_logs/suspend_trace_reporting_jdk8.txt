= Invalid execution results =
| ----------------------- |
|  Thread 1   | Thread 2  |
| ----------------------- |
| foo(): void | bar(): -1 |
| ----------------------- |

The following interleaving leads to the error:
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
|                                                                Thread 1                                                                 |                                                      Thread 2                                                      |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
|                                                                                                                                         | bar(): -1                                                                                                          |
|                                                                                                                                         |   barStarted = true at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:38)                              |
|                                                                                                                                         |   lock.lock(null) [suspendable: Continuation#1] at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:194) |
|                                                                                                                                         |   counter ➜ 0 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                                    |
|                                                                                                                                         |   counter = 1 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                                    |
|                                                                                                                                         |   lock.unlock(null) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:198)                             |
|                                                                                                                                         |     isLocked(): true at MutexImpl.unlock(Mutex.kt:213)                                                             |
|                                                                                                                                         |     owner.get(): null at MutexImpl.unlock(Mutex.kt:215)                                                            |
|                                                                                                                                         |     switch                                                                                                         |
| foo()                                                                                                                                   |                                                                                                                    |
|   barStarted ➜ true at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29)                                                   |                                                                                                                    |
|   canEnterForbiddenBlock = true at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29)                                       |                                                                                                                    |
|   lock.lock(null) [suspendable: Continuation#2]: COROUTINE_SUSPENDED at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:184) |                                                                                                                    |
|     tryLock(null): false at MutexImpl.lock(Mutex.kt:0)                                                                                  |                                                                                                                    |
|     lockSuspend(null) [suspendable: Continuation#2]: COROUTINE_SUSPENDED at MutexImpl.lock(Mutex.kt:0)                                  |                                                                                                                    |
|       acquire() [suspendable: Continuation#5] at MutexImpl.lockSuspend(Mutex.kt:177)                                                    |                                                                                                                    |
|       cancellable.getResult(): COROUTINE_SUSPENDED at MutexImpl.lockSuspend(Mutex.kt:321)                                               |                                                                                                                    |
|         isReusable(): false at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:297)                                |                                                                                                                    |
|         trySuspend(): true at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:300)                                 |                                                                                                                    |
|         getParentHandle(): null at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:310)                            |                                                                                                                    |
|         switch                                                                                                                          |                                                                                                                    |
|                                                                                                                                         |     owner.compareAndSet(null, <NO_OWNER>): true at MutexImpl.unlock(Mutex.kt:220)                                  |
|                                                                                                                                         |     release() at MutexImpl.unlock(Mutex.kt:222)                                                                    |
|                                                                                                                                         |   canEnterForbiddenBlock ➜ true at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:42)                  |
|                                                                                                                                         |   result: -1                                                                                                       |
|         installParentHandle(): ChildContinuation#1 at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:311)         |                                                                                                                    |
|   counter ➜ 1 at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:31)                                                         |                                                                                                                    |
|   counter = 2 at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:31)                                                         |                                                                                                                    |
|   lock.unlock(null) at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:188)                                                  |                                                                                                                    |
|   canEnterForbiddenBlock = false at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:33)                                      |                                                                                                                    |
|   result: void                                                                                                                          |                                                                                                                    |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |

Detailed trace:
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                                                                           Thread 1                                                                                           |                                                                                               Thread 2                                                                                               |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                                                                                                                                                                              | bar(): -1                                                                                                                                                                                            |
|                                                                                                                                                                                              |   barStarted = true at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:38)                                                                                                                |
|                                                                                                                                                                                              |   lock.lock(null) [suspendable: Continuation#1] at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:194)                                                                                   |
|                                                                                                                                                                                              |     tryLock(null): true at MutexImpl.lock(Mutex.kt:0)                                                                                                                                                |
|                                                                                                                                                                                              |       tryLockImpl(null): 0 at MutexImpl.tryLock(Mutex.kt:183)                                                                                                                                        |
|                                                                                                                                                                                              |         tryAcquire(): true at MutexImpl.tryLockImpl(Mutex.kt:189)                                                                                                                                    |
|                                                                                                                                                                                              |           _availablePermits.get(): 1 at SemaphoreImpl.tryAcquire(Semaphore.kt:159)                                                                                                                   |
|                                                                                                                                                                                              |           _availablePermits.compareAndSet(1, 0): true at SemaphoreImpl.tryAcquire(Semaphore.kt:171)                                                                                                  |
|                                                                                                                                                                                              |         owner.get(): <NO_OWNER> at MutexImpl.tryLockImpl(Mutex.kt:190)                                                                                                                               |
|                                                                                                                                                                                              |         owner.set(null) at MutexImpl.tryLockImpl(Mutex.kt:191)                                                                                                                                       |
|                                                                                                                                                                                              |   counter ➜ 0 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                                                                                                                      |
|                                                                                                                                                                                              |   counter = 1 at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:40)                                                                                                                      |
|                                                                                                                                                                                              |   lock.unlock(null) at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:198)                                                                                                               |
|                                                                                                                                                                                              |     isLocked(): true at MutexImpl.unlock(Mutex.kt:213)                                                                                                                                               |
|                                                                                                                                                                                              |       getAvailablePermits(): 0 at MutexImpl.isLocked(Mutex.kt:149)                                                                                                                                   |
|                                                                                                                                                                                              |         _availablePermits.get(): 0 at SemaphoreImpl.getAvailablePermits(Semaphore.kt:152)                                                                                                            |
|                                                                                                                                                                                              |     owner.get(): null at MutexImpl.unlock(Mutex.kt:215)                                                                                                                                              |
|                                                                                                                                                                                              |     switch                                                                                                                                                                                           |
| foo()                                                                                                                                                                                        |                                                                                                                                                                                                      |
|   barStarted ➜ true at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29)                                                                                                        |                                                                                                                                                                                                      |
|   canEnterForbiddenBlock = true at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:29)                                                                                            |                                                                                                                                                                                                      |
|   lock.lock(null) [suspendable: Continuation#2]: COROUTINE_SUSPENDED at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:184)                                                      |                                                                                                                                                                                                      |
|     tryLock(null): false at MutexImpl.lock(Mutex.kt:0)                                                                                                                                       |                                                                                                                                                                                                      |
|       tryLockImpl(null): 1 at MutexImpl.tryLock(Mutex.kt:183)                                                                                                                                |                                                                                                                                                                                                      |
|         tryAcquire(): false at MutexImpl.tryLockImpl(Mutex.kt:189)                                                                                                                           |                                                                                                                                                                                                      |
|           _availablePermits.get(): 0 at SemaphoreImpl.tryAcquire(Semaphore.kt:159)                                                                                                           |                                                                                                                                                                                                      |
|     lockSuspend(null) [suspendable: Continuation#2]: COROUTINE_SUSPENDED at MutexImpl.lock(Mutex.kt:0)                                                                                       |                                                                                                                                                                                                      |
|       acquire() [suspendable: Continuation#5] at MutexImpl.lockSuspend(Mutex.kt:177)                                                                                                         |                                                                                                                                                                                                      |
|         decPermits(): 0 at SemaphoreImpl.acquire(Semaphore.kt:413)                                                                                                                           |                                                                                                                                                                                                      |
|           _availablePermits.getAndDecrement(): 0 at SemaphoreImpl.decPermits(Semaphore.kt:237)                                                                                               |                                                                                                                                                                                                      |
|         addAcquireToQueue(Continuation#5): true at SemaphoreImpl.acquire(Semaphore.kt:199)                                                                                                   |                                                                                                                                                                                                      |
|           tail.get(): SemaphoreSegment#1 at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:286)                                                                                                |                                                                                                                                                                                                      |
|           enqIdx.getAndIncrement(): 0 at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:287)                                                                                                   |                                                                                                                                                                                                      |
|           ConcurrentLinkedListKt.findSegmentInternal(SemaphoreSegment#1, 0, addAcquireToQueue$createNewSegment$1#1): SemaphoreSegment#1 at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:432) |                                                                                                                                                                                                      |
|             cur.isRemoved(): false at ConcurrentLinkedListKt.findSegmentInternal(ConcurrentLinkedList.kt:26)                                                                                 |                                                                                                                                                                                                      |
|               cleanedAndPointers.get(): 131072 at Segment.isRemoved(ConcurrentLinkedList.kt:222)                                                                                             |                                                                                                                                                                                                      |
|           tail.get(): SemaphoreSegment#1 at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:433)                                                                                                |                                                                                                                                                                                                      |
|           segment.cas() at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:293)                                                                                                                 |                                                                                                                                                                                                      |
|             acquirers[0].compareAndSet(null, Continuation#5): true at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:442)                                                                      |                                                                                                                                                                                                      |
|           waiter.invokeOnCancellation(SemaphoreSegment#1, 0) at SemaphoreImpl.addAcquireToQueue(Semaphore.kt:294)                                                                            |                                                                                                                                                                                                      |
|             cont.invokeOnCancellation(SemaphoreSegment#1, 0) at MutexImpl.CancellableContinuationWithOwner.invokeOnCancellation(Mutex.kt:0)                                                  |                                                                                                                                                                                                      |
|               _decisionAndIndex.get(): 536870911 at CancellableContinuationImpl.invokeOnCancellation(CancellableContinuationImpl.kt:0)                                                       |                                                                                                                                                                                                      |
|               _decisionAndIndex.compareAndSet(536870911, 0): true at CancellableContinuationImpl.invokeOnCancellation(CancellableContinuationImpl.kt:392)                                    |                                                                                                                                                                                                      |
|               invokeOnCancellationImpl(SemaphoreSegment#1) at CancellableContinuationImpl.invokeOnCancellation(CancellableContinuationImpl.kt:394)                                           |                                                                                                                                                                                                      |
|                 _state.get(): Active#1 at CancellableContinuationImpl.invokeOnCancellationImpl(CancellableContinuationImpl.kt:403)                                                           |                                                                                                                                                                                                      |
|                 _state.compareAndSet(Active#1, SemaphoreSegment#1): true at CancellableContinuationImpl.invokeOnCancellationImpl(CancellableContinuationImpl.kt:407)                         |                                                                                                                                                                                                      |
|       cancellable.getResult(): COROUTINE_SUSPENDED at MutexImpl.lockSuspend(Mutex.kt:321)                                                                                                    |                                                                                                                                                                                                      |
|         isReusable(): false at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:297)                                                                                     |                                                                                                                                                                                                      |
|           resumeMode ➜ 1 at CancellableContinuationImpl.isReusable(CancellableContinuationImpl.kt:141)                                                                                       |                                                                                                                                                                                                      |
|         trySuspend(): true at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:300)                                                                                      |                                                                                                                                                                                                      |
|           _decisionAndIndex.get(): 0 at CancellableContinuationImpl.trySuspend(CancellableContinuationImpl.kt:0)                                                                             |                                                                                                                                                                                                      |
|           _decisionAndIndex.compareAndSet(0, 536870912): true at CancellableContinuationImpl.trySuspend(CancellableContinuationImpl.kt:278)                                                  |                                                                                                                                                                                                      |
|         getParentHandle(): null at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:310)                                                                                 |                                                                                                                                                                                                      |
|           _parentHandle.get(): null at CancellableContinuationImpl.getParentHandle(CancellableContinuationImpl.kt:106)                                                                       |                                                                                                                                                                                                      |
|         switch                                                                                                                                                                               |                                                                                                                                                                                                      |
|                                                                                                                                                                                              |     owner.compareAndSet(null, <NO_OWNER>): true at MutexImpl.unlock(Mutex.kt:220)                                                                                                                    |
|                                                                                                                                                                                              |     release() at MutexImpl.unlock(Mutex.kt:222)                                                                                                                                                      |
|                                                                                                                                                                                              |       _availablePermits.getAndIncrement(): -1 at SemaphoreImpl.release(Semaphore.kt:250)                                                                                                             |
|                                                                                                                                                                                              |       tryResumeNextFromQueue(): true at SemaphoreImpl.release(Semaphore.kt:265)                                                                                                                      |
|                                                                                                                                                                                              |         head.get(): SemaphoreSegment#1 at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:319)                                                                                                     |
|                                                                                                                                                                                              |         deqIdx.getAndIncrement(): 0 at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:320)                                                                                                        |
|                                                                                                                                                                                              |         ConcurrentLinkedListKt.findSegmentInternal(SemaphoreSegment#1, 0, tryResumeNextFromQueue$createNewSegment$1#1): SemaphoreSegment#1 at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:446) |
|                                                                                                                                                                                              |           cur.isRemoved(): false at ConcurrentLinkedListKt.findSegmentInternal(ConcurrentLinkedList.kt:26)                                                                                           |
|                                                                                                                                                                                              |             cleanedAndPointers.get(): 131072 at Segment.isRemoved(ConcurrentLinkedList.kt:222)                                                                                                       |
|                                                                                                                                                                                              |         head.get(): SemaphoreSegment#1 at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:447)                                                                                                     |
|                                                                                                                                                                                              |         segment.cleanPrev() at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:325)                                                                                                                |
|                                                                                                                                                                                              |           _prev.lazySet(null) at ConcurrentLinkedListNode.cleanPrev(ConcurrentLinkedList.kt:132)                                                                                                     |
|                                                                                                                                                                                              |         segment.getAndSet() at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:328)                                                                                                                |
|                                                                                                                                                                                              |           acquirers[0].getAndSet(<PERMIT>): Continuation#5 at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:456)                                                                                 |
|                                                                                                                                                                                              |         tryResumeAcquire(Continuation#5): true at SemaphoreImpl.tryResumeNextFromQueue(Semaphore.kt:340)                                                                                             |
|                                                                                                                                                                                              |           $this$tryResumeAcquire.tryResume(Unit, null, onCancellationRelease$1#1): <RESUME_TOKEN> at SemaphoreImpl.tryResumeAcquire(Semaphore.kt:347)                                                |
|                                                                                                                                                                                              |             tryResume(Unit, null, onCancellationRelease$1#1): <RESUME_TOKEN> at MutexImpl.CancellableContinuationWithOwner.tryResume(Mutex.kt:250)                                                   |
|                                                                                                                                                                                              |               owner.get(): <NO_OWNER> at MutexImpl.CancellableContinuationWithOwner.tryResume(Mutex.kt:257)                                                                                          |
|                                                                                                                                                                                              |               cont.tryResume(Unit, null, tryResume$token$1#1): <RESUME_TOKEN> at MutexImpl.CancellableContinuationWithOwner.tryResume(Mutex.kt:258)                                                  |
|                                                                                                                                                                                              |                 tryResumeImpl(Unit, null, tryResume$token$1#1): <RESUME_TOKEN> at CancellableContinuationImpl.tryResume(CancellableContinuationImpl.kt:582)                                          |
|                                                                                                                                                                                              |                   _state.get(): SemaphoreSegment#1 at CancellableContinuationImpl.tryResumeImpl(CancellableContinuationImpl.kt:0)                                                                    |
|                                                                                                                                                                                              |                   resumeMode ➜ 1 at CancellableContinuationImpl.tryResumeImpl(CancellableContinuationImpl.kt:540)                                                                                    |
|                                                                                                                                                                                              |                   _state.compareAndSet(SemaphoreSegment#1, CompletedContinuation#1): true at CancellableContinuationImpl.tryResumeImpl(CancellableContinuationImpl.kt:541)                           |
|                                                                                                                                                                                              |                   detachChildIfNonResuable() at CancellableContinuationImpl.tryResumeImpl(CancellableContinuationImpl.kt:542)                                                                        |
|                                                                                                                                                                                              |                     isReusable(): false at CancellableContinuationImpl.detachChildIfNonResuable(CancellableContinuationImpl.kt:565)                                                                  |
|                                                                                                                                                                                              |                       resumeMode ➜ 1 at CancellableContinuationImpl.isReusable(CancellableContinuationImpl.kt:141)                                                                                   |
|                                                                                                                                                                                              |                     detachChild() at CancellableContinuationImpl.detachChildIfNonResuable(CancellableContinuationImpl.kt:565)                                                                        |
|                                                                                                                                                                                              |                       getParentHandle(): null at CancellableContinuationImpl.detachChild(CancellableContinuationImpl.kt:572)                                                                         |
|                                                                                                                                                                                              |                         _parentHandle.get(): null at CancellableContinuationImpl.getParentHandle(CancellableContinuationImpl.kt:106)                                                                 |
|                                                                                                                                                                                              |               owner.get(): <NO_OWNER> at MutexImpl.CancellableContinuationWithOwner.tryResume(Mutex.kt:264)                                                                                          |
|                                                                                                                                                                                              |               owner.set(null) at MutexImpl.CancellableContinuationWithOwner.tryResume(Mutex.kt:265)                                                                                                  |
|                                                                                                                                                                                              |           $this$tryResumeAcquire.completeResume(<RESUME_TOKEN>) at SemaphoreImpl.tryResumeAcquire(Semaphore.kt:349)                                                                                  |
|                                                                                                                                                                                              |             cont.completeResume(<RESUME_TOKEN>) at MutexImpl.CancellableContinuationWithOwner.completeResume(Mutex.kt:0)                                                                             |
|                                                                                                                                                                                              |               resumeMode ➜ 1 at CancellableContinuationImpl.completeResume(CancellableContinuationImpl.kt:590)                                                                                       |
|                                                                                                                                                                                              |               dispatchResume(1) at CancellableContinuationImpl.completeResume(CancellableContinuationImpl.kt:590)                                                                                    |
|                                                                                                                                                                                              |                 tryResume(): false at CancellableContinuationImpl.dispatchResume(CancellableContinuationImpl.kt:472)                                                                                 |
|                                                                                                                                                                                              |                   _decisionAndIndex.get(): 536870912 at CancellableContinuationImpl.tryResume(CancellableContinuationImpl.kt:0)                                                                      |
|                                                                                                                                                                                              |                 DispatchedTaskKt.dispatch(Continuation#4, 1) at CancellableContinuationImpl.dispatchResume(CancellableContinuationImpl.kt:474)                                                       |
|                                                                                                                                                                                              |                   DispatchedTaskKt.resume(Continuation#4, Continuation#3, false) at DispatchedTaskKt.dispatch(DispatchedTask.kt:168)                                                                 |
|                                                                                                                                                                                              |                     $this$resume.takeState(): CompletedContinuation#1 at DispatchedTaskKt.resume(DispatchedTask.kt:174)                                                                              |
|                                                                                                                                                                                              |                       getState(): CompletedContinuation#1 at CancellableContinuationImpl.takeState(CancellableContinuationImpl.kt:168)                                                               |
|                                                                                                                                                                                              |                         _state.get(): CompletedContinuation#1 at CancellableContinuationImpl.getState(CancellableContinuationImpl.kt:108)                                                            |
|                                                                                                                                                                                              |   canEnterForbiddenBlock ➜ true at SuspendTraceReportingTest.bar(SuspendTraceReportingTest.kt:42)                                                                                                    |
|                                                                                                                                                                                              |   result: -1                                                                                                                                                                                         |
|         installParentHandle(): ChildContinuation#1 at CancellableContinuationImpl.getResult(CancellableContinuationImpl.kt:311)                                                              |                                                                                                                                                                                                      |
|           _parentHandle.compareAndSet(null, ChildContinuation#1): true at CancellableContinuationImpl.installParentHandle(CancellableContinuationImpl.kt:352)                                |                                                                                                                                                                                                      |
|   counter ➜ 1 at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:31)                                                                                                              |                                                                                                                                                                                                      |
|   counter = 2 at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:31)                                                                                                              |                                                                                                                                                                                                      |
|   lock.unlock(null) at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:188)                                                                                                       |                                                                                                                                                                                                      |
|     isLocked(): true at MutexImpl.unlock(Mutex.kt:213)                                                                                                                                       |                                                                                                                                                                                                      |
|       getAvailablePermits(): 0 at MutexImpl.isLocked(Mutex.kt:149)                                                                                                                           |                                                                                                                                                                                                      |
|         _availablePermits.get(): 0 at SemaphoreImpl.getAvailablePermits(Semaphore.kt:152)                                                                                                    |                                                                                                                                                                                                      |
|     owner.get(): null at MutexImpl.unlock(Mutex.kt:215)                                                                                                                                      |                                                                                                                                                                                                      |
|     owner.compareAndSet(null, <NO_OWNER>): true at MutexImpl.unlock(Mutex.kt:220)                                                                                                            |                                                                                                                                                                                                      |
|     release() at MutexImpl.unlock(Mutex.kt:222)                                                                                                                                              |                                                                                                                                                                                                      |
|       _availablePermits.getAndIncrement(): 0 at SemaphoreImpl.release(Semaphore.kt:250)                                                                                                      |                                                                                                                                                                                                      |
|   canEnterForbiddenBlock = false at SuspendTraceReportingTest.foo(SuspendTraceReportingTest.kt:33)                                                                                           |                                                                                                                                                                                                      |
|   result: void                                                                                                                                                                               |                                                                                                                                                                                                      |
| --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
